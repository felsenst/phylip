/* Version 4.0. (c) Copyright 1993-2013 by the University of Washington.
   Written by Joseph Felsenstein, Akiko Fuseki, Sean Lamont, and Andrew Keeffe.
   Permission is granted to copy and use this program provided no fee is
   charged for it and provided that this copyright notice is not removed. */


#ifdef HAVE_CONFIG_H
#  include <config.h>
#endif

#include "phylip.h"
#include "pmatrix.h"
#include "seq.h"


typedef long *steparray;

/* Only one is enabled at a time, but done as a bitset for easy combination */
typedef enum protdist_method {
  jtt           = 0x01,
  pmb           = 0x02,
  pam           = 0x04,
  mtrev         = 0x08,
  wag           = 0x10,
  mtmam         = 0x20,
  kimura        = 0x40,
  similarity    = 0x80,
  categories    = 0x100
} protdist_method;

typedef enum {
  universal, ciliate, mito, vertmito, flymito, yeastmito
} codetype;

typedef enum {
  chemical, hall, george
} cattype;

typedef double matrix[20][20];

typedef boolean bool;

/* Default options */
protdist_method method  = jtt;
bool    weights         = false;
bool    printdata       = false;
bool    progress        = true;
bool    interleaved     = true;
double  ttratio         = 2.0;
codetype whichcode      = universal;
cattype  whichcat       = george;
bool    basesequal      = true;
bool    gama            = false;
bool    invar           = false;
double  invarfrac       = 0.0;
double  ease            = 0.457;
double  fracchange      = 1.0;

double  freqa = 0.25, freqc = 0.25, freqg = 0.25, freqt = 0.25;

long chars, datasets, ith, ctgry, categs;
/* spp = number of species
   chars = length of sequences */
double cvi, xi, xv;
boolean justwts, mulsets, firstset, lower;
steptr oldweight;
double rate[maxcategs];
aas **gnode = NULL;
double pie[20];
long cat[(long)ser - (long)ala + 1], numaa[(long)ser - (long)ala + 1];
double **eigvecs = NULL;
double **prob    = NULL;
double *eig      = NULL;
double **d;
char infilename[100], outfilename[100], catfilename[100], weightfilename[100];

/* Local variables for makedists, propagated globally for C version: */
double tt, p, dp, d2p, q, elambdat;

/* Translation table for basic DNA codons. May be slightly modified in code()
 * depending on the model */
/* indices 0123 <=> UCAG */
aas trans[4][4][4] =
{
  {
    {phe, phe, leu, leu}, {ser, ser, ser, ser},
    {tyr, tyr, stop, stop}, {cys, cys, stop, trp}
  },
  {
    {leu, leu, leu, leu}, {pro, pro, pro, pro},
    {his, his, gln, gln}, {arg, arg, arg, arg}
  },
  {
    {ileu, ileu, ileu, met}, {thr, thr, thr, thr},
    {asn, asn, lys, lys}, {ser, ser, arg, arg}
  },
  {
    {val, val, val, val}, {ala, ala, ala, ala},
    {asp, asp, glu, glu}, {gly, gly, gly, gly}
  }
};

/* this jtt matrix decomposition due to Elisabeth  Tillier and Matthew Spencer */

static double jtteigs[] =
{+0.00000000000000, -1.81721720738768, -1.87965834528616, -1.61403121885431,
 -1.53896608443751, -1.40486966367848, -1.30995061286931, -1.24668414819041,
 -1.17179756521289, -0.31033320987464, -0.34602837857034, -1.06031718484613,
 -0.99900602987105, -0.45576774888948, -0.86014403434677, -0.54569432735296,
 -0.76866956571861, -0.60593589295327, -0.65119724379348, -0.70249806480753};

static double jttprobs[20][20] =
{{+0.07686196156903, +0.05105697447152, +0.04254597872702, +0.05126897436552,
  +0.02027898986051, +0.04106097946952, +0.06181996909002, +0.07471396264303,
  +0.02298298850851, +0.05256897371552, +0.09111095444453, +0.05949797025102,
  +0.02341398829301, +0.04052997973502, +0.05053197473402, +0.06822496588753,
  +0.05851797074102, +0.01433599283201, +0.03230298384851, +0.06637396681302},
 {-0.04445795120462, -0.01557336502860, -0.09314817363516, +0.04411372100382,
  -0.00511178725134, +0.00188472427522, -0.02176250428454, -0.01330231089224,
  +0.01004072641973, +0.02707838224285, -0.00785039050721, +0.02238829876349,
  +0.00257470703483, -0.00510311699563, -0.01727154263346, +0.20074235330882,
  -0.07236268502973, -0.00012690116016, -0.00215974664431, -0.01059243778174},
 {+0.09480046389131, +0.00082658405814, +0.01530023104155, -0.00639909042723,
  +0.00160605602061, +0.00035896642912, +0.00199161318384, -0.00220482855717,
  -0.00112601328033, +0.14840201765438, -0.00344295714983, -0.00123976286718,
  -0.00439399942758, +0.00032478785709, -0.00104270266394, -0.02596605592109,
  -0.05645800566901, +0.00022319903170, -0.00022792271829, -0.16133258048606},
 {-0.06924141195400, -0.01816245289173, -0.08104005811201, +0.08985697111009,
  +0.00279659017898, +0.01083740322821, -0.06449599336038, +0.01794514261221,
  +0.01036809141699, +0.04283504450449, +0.00634472273784, +0.02339134834111,
  -0.01748667848380, +0.00161859106290, +0.00622486432503, -0.05854130195643,
  +0.15083728660504, +0.00030733757661, -0.00143739522173, -0.05295810171941},
 {-0.14637948915627, +0.02029296323583, +0.02615316895036, -0.10311538564943,
  -0.00183412744544, -0.02589124656591, +0.11073673851935, +0.00848581728407,
  +0.00106057791901, +0.05530240732939, -0.00031533506946, -0.03124002869407,
  -0.01533984125301, -0.00288717337278, +0.00272787410643, +0.06300929916280,
  +0.07920438311152, -0.00041335282410, -0.00011648873397, -0.03944076085434},
 {-0.05558229086909, +0.08935293782491, +0.04869509588770, +0.04856877988810,
  -0.00253836047720, +0.07651693957635, -0.06342453535092, -0.00777376246014,
  -0.08570270266807, +0.01943016473512, -0.00599516526932, -0.09157595008575,
  -0.00397735155663, -0.00440093863690, -0.00232998056918, +0.02979967701162,
  -0.00477299485901, -0.00144011795333, +0.01795114942404, -0.00080059359232},
 {+0.05807741644682, +0.14654292420341, -0.06724975334073, +0.02159062346633,
  -0.00339085518294, -0.06829036785575, +0.03520631903157, -0.02766062718318,
  +0.03485632707432, -0.02436836692465, -0.00397566003573, -0.10095488644404,
  +0.02456887654357, +0.00381764117077, -0.00906261340247, -0.01043058066362,
  +0.01651199513994, -0.00210417220821, -0.00872508520963, -0.01495915462580},
 {+0.02564617106907, +0.02960554611436, -0.00052356748770, +0.00989267817318,
  -0.00044034172141, -0.02279910634723, -0.00363768356471, -0.01086345665971,
  +0.01229721799572, +0.02633650142592, +0.06282966783922, -0.00734486499924,
  -0.13863936313277, -0.00993891943390, -0.00655309682350, -0.00245191788287,
  -0.02431633805559, -0.00068554031525, -0.00121383858869, +0.06280025239509},
 {+0.11362428251792, -0.02080375718488, -0.08802750967213, -0.06531316372189,
  -0.00166626058292, +0.06846081717224, +0.07007301248407, -0.01713112936632,
  -0.05900588794853, -0.04497159138485, +0.04222484636983, +0.00129043178508,
  -0.01550337251561, -0.01553102163852, -0.04363429852047, +0.01600063777880,
  +0.05787328925647, -0.00008265841118, +0.02870014572813, -0.02657681214523},
 {+0.01840541226842, +0.00610159018805, +0.01368080422265, +0.02383751807012,
  -0.00923516894192, +0.01209943150832, +0.02906782189141, +0.01992384905334,
  +0.00197323568330, +0.00017531415423, -0.01796698381949, +0.01887083962858,
  -0.00063335886734, -0.02365277334702, +0.01209445088200, +0.01308086447947,
  +0.01286727242301, -0.11420358975688, -0.01886991700613, +0.00238338728588},
 {-0.01100105031759, -0.04250695864938, -0.02554356700969, -0.05473632078607,
  +0.00725906469946, -0.03003724918191, -0.07051526125013, -0.06939439879112,
  -0.00285883056088, +0.05334304124753, +0.12839241846919, -0.05883473754222,
  +0.02424304967487, +0.09134510778469, -0.00226003347193, -0.01280041778462,
  -0.00207988305627, -0.02957493909199, +0.05290385686789, +0.05465710875015},
 {-0.01421274522011, +0.02074863337778, -0.01006411985628, +0.03319995456446,
  -0.00005371699269, -0.12266046460835, +0.02419847062899, -0.00441168706583,
  -0.08299118738167, -0.00323230913482, +0.02954035119881, +0.09212856795583,
  +0.00718635627257, -0.02706936115539, +0.04473173279913, -0.01274357634785,
  -0.01395862740618, -0.00071538848681, +0.04767640012830, -0.00729728326990},
 {-0.03797680968123, +0.01280286509478, -0.08614616553187, -0.01781049963160,
  +0.00674319990083, +0.04208667754694, +0.05991325707583, +0.03581015660092,
  -0.01529816709967, +0.06885987924922, -0.11719120476535, -0.00014333663810,
  +0.00074336784254, +0.02893416406249, +0.07466151360134, -0.08182016471377,
  -0.06581536577662, -0.00018195976501, +0.00167443595008, +0.09015415667825},
 {+0.03577726799591, -0.02139253448219, -0.01137813538175, -0.01954939202830,
  -0.04028242801611, -0.01777500032351, -0.02106862264440, +0.00465199658293,
  -0.02824805812709, +0.06618860061778, +0.08437791757537, -0.02533125946051,
  +0.02806344654855, -0.06970805797879, +0.02328376968627, +0.00692992333282,
  +0.02751392122018, +0.01148722812804, -0.11130404325078, +0.07776346000559},
 {-0.06014297925310, -0.00711674355952, -0.02424493472566, +0.00032464353156,
  +0.00321221847573, +0.03257969053884, +0.01072805771161, +0.06892027923996,
  +0.03326534127710, -0.01558838623875, +0.13794237677194, -0.04292623056646,
  +0.01375763233229, -0.11125153774789, +0.03510076081639, -0.04531670712549,
  -0.06170413486351, -0.00182023682123, +0.05979891871679, -0.02551802851059},
 {-0.03515069991501, +0.02310847227710, +0.00474493548551, +0.02787717003457,
  -0.12038329679812, +0.03178473522077, +0.04445111601130, -0.05334957493090,
  +0.01290386678474, -0.00376064171612, +0.03996642737967, +0.04777677295520,
  +0.00233689200639, +0.03917715404594, -0.01755598277531, -0.03389088626433,
  -0.02180780263389, +0.00473402043911, +0.01964539477020, -0.01260807237680},
 {-0.04120428254254, +0.00062717164978, -0.01688703578637, +0.01685776910152,
  +0.02102702093943, +0.01295781834163, +0.03541815979495, +0.03968150445315,
  -0.02073122710938, -0.06932247350110, +0.11696314241296, -0.00322523765776,
  -0.01280515661402, +0.08717664266126, +0.06297225078802, -0.01290501780488,
  -0.04693925076877, -0.00177653675449, -0.08407812137852, -0.08380714022487},
 {+0.03138655228534, -0.09052573757196, +0.00874202219428, +0.06060593729292,
  -0.03426076652151, -0.04832468257386, +0.04735628794421, +0.14504653737383,
  -0.01709111334001, -0.00278794215381, -0.03513813820550, -0.11690294831883,
  -0.00836264902624, +0.03270980973180, -0.02587764129811, +0.01638786059073,
  +0.00485499822497, +0.00305477087025, +0.02295754527195, +0.00616929722958},
 {-0.04898722042023, -0.01460879656586, +0.00508708857036, +0.07730497806331,
  +0.04252420017435, +0.00484232580349, +0.09861807969412, -0.05169447907187,
  -0.00917820907880, +0.03679081047330, +0.04998537112655, +0.00769330211980,
  +0.01805447683564, -0.00498723245027, -0.14148416183376, -0.05170281760262,
  -0.03230723310784, -0.00032890672639, -0.02363523071957, +0.03801365471627},
 {-0.02047562162108, +0.06933781779590, -0.02101117884731, -0.06841945874842,
  -0.00860967572716, -0.00886650271590, -0.07185241332269, +0.16703684361030,
  -0.00635847581692, +0.00811478913823, +0.01847205842216, +0.06700967948643,
  +0.00596607376199, +0.02318239240593, -0.10552958537847, -0.01980199747773,
  -0.02003785382406, -0.00593392430159, -0.00965391033612, +0.00743094349652}};

/* PMB matrix decomposition courtesy of Elisabeth Tillier */
static double pmbeigs[] =
{0.0000001586972220, -1.8416770496147100, -1.6025046986139100, -1.5801012515121300,
 -1.4987794099715900, -1.3520794233801900, -1.3003469390479700, -1.2439503327631300,
 -1.1962574080244200, -1.1383730501367500, -1.1153278910708000, -0.4934843510654760,
 -0.5419014550215590, -0.9657997830826700, -0.6276075673757390, -0.6675927795018510,
 -0.6932641383465870, -0.8897872681859630, -0.8382698977371710, -0.8074694642446040};

static double pmbprobs[20][20] =
{{0.0771762457248147, 0.0531913844998640, 0.0393445076407294, 0.0466756566755510,
  0.0286348361997465, 0.0312327748383639, 0.0505410248721427, 0.0767106611472993,
  0.0258916271688597, 0.0673140562194124, 0.0965705469252199, 0.0515979465932174,
  0.0250628079438675, 0.0503492018628350, 0.0399908189418273, 0.0641898881894471,
  0.0517539616710987, 0.0143507440546115, 0.0357994592438322, 0.0736218495862984},
 {0.0368263046116572, -0.0006728917107827, 0.0008590805287740, -0.0002764255356960,
  0.0020152937187455, 0.0055743720652960, 0.0003213317669367, 0.0000449190281568,
  -0.0004226254397134, 0.1805040629634510, -0.0272246813586204, 0.0005904606533477,
  -0.0183743200073889, -0.0009194625608688, 0.0008173657533167, -0.0262629806302238,
  0.0265738757209787, 0.0002176606241904, 0.0021315644838566, -0.1823229927207580},
 {-0.0194800075560895, 0.0012068088610652, -0.0008803318319596, -0.0016044273960017,
  -0.0002938633803197, -0.0535796754602196, 0.0155163896648621, -0.0015006360762140,
  0.0021601372013703, 0.0268513218744797, -0.1085292493742730, 0.0149753083138452,
  0.1346457366717310, -0.0009371698759829, 0.0013501708044116, 0.0346352293103622,
  -0.0276963770242276, 0.0003643142783940, 0.0002074817333067, -0.0174108903914110},
 {0.0557839400850153, 0.0023271577185437, 0.0183481103396687, 0.0023339480096311,
  0.0002013267015151, -0.0227406863569852, 0.0098644845475047, 0.0064721276774396,
  0.0001389408104210, -0.0473713878768274, -0.0086984445005797, 0.0026913674934634,
  0.0283724052562196, 0.0001063665179457, 0.0027442574779383, -0.1875312134708470,
  0.1279864877057640, 0.0005103347834563, 0.0003155113168637, 0.0081451082759554},
 {0.0037510125027265, 0.0107095920636885, 0.0147305410328404, -0.0112351252180332,
  -0.0001500408626446, -0.1523450933729730, 0.0611532413339872, -0.0005496748939503,
  0.0048714378736644, -0.0003826320053999, 0.0552010244407311, 0.0482555671001955,
  -0.0461664995115847, -0.0021165008617978, -0.0004574454232187, 0.0233755883688949,
  -0.0035484915422384, 0.0009090698422851, 0.0013840637687758, -0.0073895139302231},
 {-0.0111512564930024, 0.1025460064723080, 0.0396772456883791, -0.0298408501361294,
  -0.0001656742634733, -0.0079876311843289, 0.0712644184507945, -0.0010780604625230,
  -0.0035880882043592, 0.0021070399334252, 0.0016716329894279, -0.1810123023850110,
  0.0015141703608724, -0.0032700852781804, 0.0035503782441679, 0.0118634302028026,
  0.0044561606458028, -0.0001576678495964, 0.0023470722225751, -0.0027457045397157},
 {0.1474525743949170, -0.0054432538500293, 0.0853848892349828, -0.0137787746207348,
  -0.0008274830358513, 0.0042248844582553, 0.0019556229305563, -0.0164191435175148,
  -0.0024501858854849, 0.0120908948084233, -0.0381456105972653, 0.0101271614855119,
  -0.0061945941321859, 0.0178841099895867, -0.0014577779202600, -0.0752120602555032,
  -0.1426985695849920, 0.0002862275078983, -0.0081191734261838, 0.0313401149422531},
 {0.0542034611735289, -0.0078763926211829, 0.0060433542506096, 0.0033396210615510,
  0.0013965072374079, 0.0067798903832256, -0.0135291136622509, -0.0089982442731848,
  -0.0056744537593887, -0.0766524225176246, 0.1881210263933930, -0.0065875518675173,
  0.0416627569300375, -0.0953804133524747, -0.0012559228448735, 0.0101622644292547,
  -0.0304742453119050, 0.0011702318499737, 0.0454733434783982, -0.1119239362388150},
 {0.1069409037912470, 0.0805064400880297, -0.1127352030714600, 0.1001181253523260,
  -0.0021480427488769, -0.0332884841459003, -0.0679837575848452, -0.0043812841356657,
  0.0153418716846395, -0.0079441315103188, -0.0121766182046363, -0.0381127991037620,
  -0.0036338726532673, 0.0195324059593791, -0.0020165963699984, -0.0061222685010268,
  -0.0253761448771437, -0.0005246410999057, -0.0112205170502433, 0.0052248485517237},
 {-0.0325247648326262, 0.0238753651653669, 0.0203684886605797, 0.0295666232678825,
  -0.0003946714764213, -0.0157242718469554, -0.0511737848084862, 0.0084725632040180,
  -0.0167068828528921, 0.0686962159427527, -0.0659702890616198, -0.0014289912494271,
  -0.0167000964093416, -0.1276689083678200, 0.0036575057830967, -0.0205958145531018,
  0.0000368919612829, 0.0014413626622426, 0.1064360941926030, 0.0863372661517408},
 {-0.0463777468104402, 0.0394712148670596, 0.1118686750747160, 0.0440711686389031,
  -0.0026076286506751, -0.0268454015202516, -0.1464943067133240, -0.0137514051835380,
  -0.0094395514284145, -0.0144124844774228, 0.0249103379323744, -0.0071832157138676,
  0.0035592787728526, 0.0415627419826693, 0.0027040097365669, 0.0337523666612066,
  0.0316121324137152, -0.0011350177559026, -0.0349998884574440, -0.0302651879823361},
 {0.0142360925194728, 0.0413145623127025, 0.0324976427846929, 0.0580930922002398,
  -0.0586974207121084, 0.0202001168873069, 0.0492204086749069, 0.1126593173463060,
  0.0116620013776662, -0.0780333711712066, -0.1109786767320410, 0.0407775100936731,
  -0.0205013161312652, -0.0653458585025237, 0.0347351829703865, 0.0304448983224773,
  0.0068813748197884, -0.0189002309261882, -0.0334507528405279, -0.0668143558699485},
 {-0.0131548829657936, 0.0044244322828034, -0.0050639951827271, -0.0038668197633889,
  -0.1536822386530220, 0.0026336969165336, 0.0021585651200470, -0.0459233839062969,
  0.0046854727140565, 0.0393815434593599, 0.0619554007991097, 0.0027456299925622,
  0.0117574347936383, 0.0373018612990383, 0.0024818527553328, -0.0133956606027299,
  -0.0020457128424105, 0.0154178819990401, 0.0246524142683911, 0.0275363065682921},
 {-0.1542307272455030, 0.0364861558267547, -0.0090880407008181, 0.0531673937889863,
  0.0157585615170580, 0.0029986538457297, 0.0180194047699875, 0.0652152443589317,
  0.0266842840376180, 0.0388457366405908, 0.0856237634510719, 0.0126955778952183,
  0.0099593861698250, -0.0013941794862563, 0.0294065511237513, -0.1151906949298290,
  -0.0852991447389655, 0.0028699120202636, -0.0332087026659522, 0.0006811857297899},
 {0.0281300736924501, -0.0584072081898638, -0.0178386569847853, -0.0536470338171487,
  -0.0186881656029960, -0.0240008730656106, -0.0541064820498883, 0.2217137098936020,
  -0.0260500001542033, 0.0234505236798375, 0.0311127151218573, -0.0494139126682672,
  0.0057093465049849, 0.0124937286655911, -0.0298322975915689, 0.0006520211333102,
  -0.0061018680727128, -0.0007081999479528, -0.0060523759094034, 0.0215845995364623},
 {0.0295321046399105, -0.0088296411830544, -0.0065057049917325, -0.0053478115612781,
  -0.0100646496794634, -0.0015473619084872, 0.0008539960632865, -0.0376381933046211,
  -0.0328135588935604, 0.0672161874239480, 0.0667626853916552, -0.0026511651464901,
  0.0140451514222062, -0.0544836996133137, 0.0427485157912094, 0.0097455780205802,
  0.0177309072915667, -0.0828759701187452, -0.0729504795471370, 0.0670731961252313},
 {0.0082646581043963, -0.0319918630534466, -0.0188454445200422, -0.0374976353856606,
  0.0037131290686848, -0.0132507796987883, -0.0306958830735725, -0.0044119395527308,
  -0.0140786756619672, -0.0180512599925078, -0.0208243802903953, -0.0232202769398931,
  -0.0063135878270273, 0.0110442171178168, 0.1824538048228460, -0.0006644614422758,
  -0.0069909097436659, 0.0255407650654681, 0.0099119399501151, -0.0140911517070698},
 {0.0261344441524861, -0.0714454044548650, 0.0159436926233439, 0.0028462736216688,
  -0.0044572637889080, -0.0089474834434532, -0.0177570282144517, -0.0153693244094452,
  0.1160919467206400, 0.0304911481385036, 0.0047047513411774, -0.0456535116423972,
  0.0004491494948617, -0.0767108879444462, -0.0012688533741441, 0.0192445965934123,
  0.0202321954782039, 0.0281039933233607, -0.0590403018490048, 0.0364080426546883},
 {0.0115826306265004, 0.1340228176509380, -0.0236200652949049, -0.1284484655137340,
  -0.0004742338006503, 0.0127617346949511, -0.0428560878860394, 0.0060030732454125,
  0.0089182609926781, 0.0085353834972860, 0.0048464809638033, 0.0709740071429510,
  0.0029940462557054, -0.0483434904493132, -0.0071713680727884, -0.0036840391887209,
  0.0031454003250096, 0.0246243550241551, -0.0449551277644180, 0.0111449232769393},
 {0.0140356721886765, -0.0196518236826680, 0.0030517022326582, 0.0582672093364850,
  -0.0000973895685457, 0.0021704767224292, 0.0341806268602705, -0.0152035987563018,
  -0.0903198657739177, 0.0259623214586925, 0.0155832497882743, -0.0040543568451651,
  0.0036477631918247, -0.0532892744763217, -0.0142569373662724, 0.0104500681408622,
  0.0103483945857315, 0.0679534422398752, -0.0768068882938636, 0.0280289727046158}};

static double pameigs[] =
{-0.00000000000000, -2.14002629929612, -1.98979275306040, -1.61725099201056,
 -2.80992186734198, -1.38594141212323, -1.31163642598910, -1.13615091597604,
 -0.94309789344695, -0.89352990819100, -0.88574592545073, -0.80708852248316,
 -0.29118988576124, -0.71609206088348, -0.35071740499615, -0.63506018793414,
 -0.58607551901193, -0.43219422054965, -0.46651052361080, -0.50178166423835};

static double pamprobs[20][20] =
{{+0.08712695643653, +0.04090397954802, +0.04043197978402, +0.04687197656402,
  +0.03347398326301, +0.03825498087251, +0.04952997523502, +0.08861195569403,
  +0.03361898319051, +0.03688598155701, +0.08535695732153, +0.08048095975953,
  +0.01475299262351, +0.03977198011401, +0.05067997466002, +0.06957696521153,
  +0.05854197072902, +0.01049399475300, +0.02991598504201, +0.06471796764102},
 {-0.05583404000123, +0.07120839966327, +0.00400805125434, -0.03129801097549,
  -0.00118034108025, -0.00005784011357, +0.02902717794652, +0.02708276678722,
  +0.00356211213890, -0.00023135837716, -0.00664026352398, -0.00508907267791,
  -0.00071251524340, -0.00486945372289, -0.00135045451646, +0.12196612602273,
  -0.18132166729332, -0.00169105641451, +0.00122917618601, +0.03219226394118},
 {-0.07742221452519, -0.03748115414437, +0.00079427741129, +0.06621455225863,
  +0.01152345334999, -0.00159215605250, -0.14912593339834, -0.02073421293717,
  -0.00257114293195, +0.00172415279055, -0.00802280919503, -0.01451474306382,
  +0.00265986667035, +0.03132192645568, +0.00846381066200, +0.05045261961766,
  -0.00052310695156, +0.00071682705274, +0.00397089071348, +0.13414509621755},
 {-0.00760157730678, -0.13464888045758, -0.00109350953234, +0.09691491222949,
  +0.00397563732586, -0.00116794506454, +0.08013959636870, -0.03419444283104,
  +0.00400280768757, +0.00313086663110, -0.01117543982112, -0.00790420559991,
  +0.00686844865706, +0.02617634632170, -0.00200399845722, +0.08338174656626,
  -0.04572409993867, -0.00363287217973, +0.00241890018298, -0.05786229078177},
 {+0.19237839429982, +0.00936920504775, -0.00103825741944, +0.01301516566682,
  -0.00298084386031, +0.00086073267605, -0.11720030397012, +0.00386967090888,
  +0.00130601783642, +0.00117039343296, -0.00011295661483, -0.00244321776948,
  -0.00345972316360, +0.00632841773974, -0.00137491528318, +0.06066536462675,
  -0.04341598435303, +0.00046026085039, -0.00240125260948, -0.11499616804210},
 {-0.00816399642309, +0.03904332577472, +0.00217615997223, +0.06920248747605,
  -0.15216640934508, -0.00215058532851, +0.00216959996160, -0.06400165079175,
  +0.00374260631293, -0.01259216064685, +0.04610273645827, +0.07567802899892,
  +0.01017707741174, -0.02129861470428, -0.00080639018503, +0.00251882906103,
  +0.00487431779457, -0.00277564548178, +0.00527652072718, +0.00299376295715},
 {-0.02416186095021, +0.06365428019728, -0.00086128898275, +0.01755739058380,
  +0.04822031962360, +0.00320976686921, +0.01201063741405, -0.19827545954260,
  +0.02106647647638, +0.01539638198766, -0.04038364027773, -0.02761490057128,
  -0.00044434555998, -0.04732971908165, -0.00351669060268, +0.10063662090176,
  +0.07607272141690, -0.00308689198314, +0.01622209629216, -0.02837189421077},
 {+0.04265086468003, +0.05340899569753, -0.00495372273040, +0.13897907859339,
  +0.03629995288715, +0.00283345888867, +0.01915891575217, +0.01131482867310,
  +0.00201020832199, +0.02842236259046, -0.06662575622256, -0.03425330796572,
  -0.02175684493748, -0.04387169128384, -0.00954341475964, -0.11730650176101,
  -0.06293401486805, +0.00540463861927, -0.00314856002941, +0.02391050985435},
 {-0.02802290490738, -0.02332819439480, +0.00369779054561, +0.01253286741895,
  -0.00325676318145, +0.00965012439579, -0.01435514190282, +0.12436012061609,
  -0.05901681100082, +0.01995423817208, -0.03286905152859, +0.02372607121939,
  +0.00693466648679, -0.14509615875613, +0.01683405825364, +0.07353193080077,
  +0.04334536836696, -0.00265234625294, -0.01565624696203, -0.01031361738910},
 {-0.02460312026951, -0.00537475481428, +0.00294583890088, -0.02467527365317,
  -0.03837469406373, -0.01283837094733, -0.00017579407388, +0.01476436566340,
  -0.00077427033892, +0.11380389559004, -0.11665175661120, +0.05120192488404,
  -0.06283825235884, +0.04536464633685, +0.00420699907266, +0.02793102015908,
  +0.02250185351213, +0.02103160879467, -0.00313272839243, -0.01431313739048},
 {-0.04987602967631, +0.02580430417529, +0.00322641605290, +0.00817708477743,
  +0.00270273782711, -0.03233401096402, -0.01845464328848, +0.03166774809972,
  +0.01193761126316, +0.06483161550157, -0.10273069702818, +0.02611359766193,
  +0.08805291780676, +0.03539792506763, +0.00638298245185, -0.02914219506402,
  -0.00180778090863, -0.02067398043140, +0.00512245365396, -0.05439805697827},
 {+0.11226928617049, -0.05641108235947, -0.01003858534543, -0.05340444138097,
  -0.01994944242374, -0.01982184819927, +0.01328602122537, -0.03683428431339,
  +0.09080224755726, +0.04204373974391, -0.03616950695684, -0.00358345207923,
  +0.01870869440641, -0.06709437992173, -0.04132141209130, -0.00682495544155,
  -0.02432097777380, -0.00310282570971, -0.00641419634325, +0.10818140123625},
 {+0.04533821906241, +0.00390771864787, +0.06410513278796, -0.00113736415880,
  -0.01515784185713, -0.01513341972953, +0.01838242817543, +0.02613045754941,
  +0.00831538904539, -0.10906786160468, -0.19095546886161, +0.01592892726831,
  -0.00519320426014, +0.01468714939066, +0.03947554726095, +0.02095600227594,
  +0.02282660804805, -0.00134761956069, +0.02643953742917, +0.03149966309106},
 {-0.10357897662612, +0.00130824113276, +0.00242439947626, +0.02114482907740,
  +0.01653594812858, -0.02663976157270, -0.03588183393957, +0.07342201348591,
  +0.13241079682933, -0.03428158637950, +0.02625156126026, +0.05234233613201,
  -0.02119791201732, -0.02855373377530, -0.01052417693312, -0.00323372082770,
  +0.00739950739543, +0.00758370109983, +0.00276244752287, -0.07969407946931},
 {+0.01637752489549, +0.01082744645546, -0.18127090190353, +0.00541276949273,
  -0.00874095186559, +0.01337228720703, +0.01243401603656, +0.03712232039942,
  +0.01168462988224, -0.02370273239977, -0.04459991935523, -0.00776987931211,
  +0.00252550755732, +0.01174601108287, +0.05000434068167, +0.02379756883452,
  +0.01831875076626, +0.00541130799291, +0.03430693933271, +0.01274296421905},
 {+0.00549856847065, +0.01009268267332, -0.00399590993125, +0.00814079798057,
  -0.00999288157006, +0.03190743162542, +0.00420829252392, +0.04235451144805,
  +0.01629269449456, +0.01174495400945, -0.00208528982939, -0.03007887724738,
  -0.03178285778040, +0.01690490621000, -0.02754455494947, +0.01552574459433,
  +0.02395525510229, -0.09259047973341, +0.00324091859590, +0.00820409331288},
 {-0.00666774930139, -0.03418043598142, +0.00610763575449, -0.02756262574224,
  +0.02916995903761, -0.00639717835500, -0.02028741838191, -0.07481914480643,
  -0.01629807929547, +0.01285607231561, +0.02033006577061, +0.13516126620161,
  -0.01259268232592, -0.03541048730445, +0.10944988432794, -0.06037590303071,
  -0.05970959312366, -0.02256932323224, +0.07136556678877, -0.00756982931580},
 {+0.03050501507852, +0.01506161517475, -0.01001594251119, +0.01676804744673,
  +0.00869702430342, -0.18125050468544, +0.01810275165595, +0.02169137128226,
  -0.02341671495253, +0.00032659000082, +0.05305287551800, -0.01596996819783,
  -0.01174880007098, +0.00435652942368, +0.00687727524281, +0.02688737383256,
  +0.02127640159418, -0.01100933685074, +0.00826892598273, +0.02153947073229},
 {+0.01848223726886, +0.00697586541112, -0.03815599945692, +0.00818172926745,
  +0.04222634101058, -0.00550240684480, +0.00604084612224, -0.03119139180410,
  -0.02035333463814, -0.03176712096642, -0.02610593028075, +0.19158013119683,
  -0.00058814592661, +0.01569309196301, -0.06179751549128, +0.00846678186931,
  -0.00175539876637, -0.00896491973514, -0.09320055014258, +0.02173568994371},
 {-0.00237681772908, -0.00273114014378, -0.00554787623529, +0.00038031746036,
  +0.01093431379624, +0.00301149416793, -0.00496583711803, +0.02334490717274,
  -0.02977882281517, -0.00649208856057, -0.00605179065586, +0.05450978926937,
  +0.00127225450745, -0.00150440564166, -0.15844580506689, +0.00271413223668,
  +0.00192239709140, +0.00785415824878, +0.11236993007742, -0.00041911006205}};

static double mtreveigs[] =
{0, -0.3204890565838896, -0.342118729655122, -0.3621199763344617,
 -0.42425349827931047, -0.4630023522299679, -0.5194737422772733,
 -0.5302951439754717, -0.5584153495101145, -0.6042595052233659,
 -0.6198173099623858, -0.628117120410433, -0.6919863715850639,
 -0.6929502926696651, -0.7032447061868652, -0.7256462874859375,
 -0.7295089293264996, -0.7722898430933931, -0.8173066967456089,
 -0.847148221517062};

static double mtrevprobs[20][20] =
{{-0.07203602702251978, -0.019009507130942526, -0.03901951463719818,
  -0.019009507130942606, -0.006003002251876636, -0.025012509382819414,
  -0.024012009007506618, -0.05602802101751522, -0.028014010508757663,
  -0.08804403302752412, -0.16808406305254608, -0.023011508632193763,
  -0.05402702026688983, -0.06103052289407924, -0.05402702026688981,
  -0.07203602702251961, -0.0860430322768985, -0.029014510884070466,
  -0.03301651238532159, -0.04302151613844923},
 {-0.017517586373701557, 0.0044690135586081935, -0.012547515478628367,
  -0.008199133151888348, -0.0001753378969220847, -0.005523069196361307,
  -0.045476579242231176, -0.020794874062075728, -0.005992851303280668,
  -0.01692090889778262, 0.008518604383321375, -0.0014906045625853457,
  -0.0043451662257916164, -0.008380023894141992, -0.008449781923272679,
  -0.006757589814677082, -0.006812209689054099, 0.15994460862472504,
  0.0018555680932886933, -0.005404562947548753},
 {-0.019277996470746055, 0.009829109719811603, 0.013202948689412925,
  0.025198260961503877, -0.0013641841815875873, -0.00029175830027572636,
  0.13526033156719267, 0.01997294506211351, 0.008661509213679263,
  -0.048477064803570634, -0.06709708888503682, 0.0005140151608483916,
  -0.0187066637882293, -0.03387581045095514, -0.00906987403394297,
  -0.0015383956564741317, -0.024671714820480216, 0.046264883187204696,
  -0.008160913902120629, -0.02637253826834758},
 {-0.008682367425506833, 0.1308245420552605, -0.0009902307786551396,
  0.0021533577789693264, 0.0018302468673956458, -8.104904463312574e-6,
  -0.02121288527128687, 0.0022004730748593436, 0.02895262905005636,
  -0.02862440289511849, -0.03506794418709437, 0.013135058042701658,
  -0.010837644809467235, -0.016660748098826256, -0.0010275830273285575,
  -0.007091584824714246, -0.010821723264122842, -0.013630810718571354,
  -0.0055818122336798795, -0.01885846443040689},
 {0.041366580707261465, -0.01653024674480136, 0.024507592966653984,
  0.07433435408793489, -0.0007696362643516623, 0.00017448933549620038,
  -0.04618750574477313, 0.1532273183177617, 0.0019542152173381067,
  -0.03767100396837566, -0.08276199085637366, -0.002666407673209008,
  -0.006531432352357671, -0.037220275378753775, -0.0017193733418939235,
  0.01820359429610238, -0.021885140265573547, 0.0017639655718305442,
  -0.015901475501720733, -0.04568762240819522},
 {0.06337177449107013, 0.008756997601184627, -0.013236110695539637,
  -0.09777320067436955, -0.0005624241015292617, -0.015625553895796642,
  0.014641343305865213, 0.13333464799733624, -0.03334176351375394,
  0.020886285164158573, -0.021351411147413693, -0.004221407588701612,
  0.00652933996807588, -0.020485809875335926, -0.010972299223996281,
  0.005275881758194924, -0.016995814866565775, 0.00658070679595712,
  -0.03235847602027496, 0.00754729452143467},
 {-0.023580632634193858, -0.013753487943110659, 0.029792955307659512,
  -0.041315887349840485, 0.002376427104771009, 0.015295305238266738,
  -0.004837712531358289, 0.013527413002170084, 0.033860556020292386,
  -0.06823881415866824, -0.06729314886673311, 0.016355028108222914,
  0.007848537788851858, 0.07798592724748295, 0.020249015342321864,
  0.023399767521499838, 0.004274668816229367, -0.0029212346062599845,
  0.09577503436099553, -0.11879971776859931},
 {0.01925779102601801, 0.009711347466813488, -0.03778095491017673,
  0.02087064997740187, 0.00004370155520335176, -0.032538042143085005,
  0.008229548456067312, 0.0068497019920590796, -0.0035481698807180045,
  0.09600925733114388, -0.1293671545711665, -0.01805893436560895,
  0.0129846019931733, 0.18440740178711504, -0.04738688991162021,
  -0.013913010875502747, -0.059550458481848645, 0.008590765794775305,
  -0.023448375298234153, -0.0013627769418097012},
 {-0.0011614155479893053, 0.008374138632152332, -0.08602969813606151,
  0.01618428070838692, -0.0037267876664575576, -0.036185555532887936,
  0.006612965037203697, 0.04254424297092725, -0.01563231128023001,
  0.013623578541869748, 0.025148275498654584, -0.012303674571282851,
  -0.01693479600077672, -0.04093898529585358, -0.046456630445416675,
  -0.010452879136453876, -0.02319653117378551, -0.004289480413052626,
  0.1335407026907291, 0.05128056112032458},
 {-0.015113725459035773, -0.006433680010864498, -0.13616818069087142,
  0.007165364605443812, 0.0024621963246728345, -0.01905359687656017,
  0.006693285040687851, 0.02092690785801855, 0.022383998163749353,
  -0.08848067590192213, 0.14662081643887498, 0.012032964095981792,
  -0.0028324603575066044, 0.033818632658193785, 0.026797585455107915,
  0.030353427780873986, 0.06998351734355532, -0.005888989655947249,
  -0.05051591792299097, -0.05475146888946158},
 {-0.005773100936949497, 0.024170804692645757, 0.021498754882537795,
  0.017262395016750306, -0.004044496016496676, 0.012913081796752797,
  0.0058602806287568815, -0.008924351183253075, -0.14436389890526954,
  -0.04201739639451209, 0.09312161964078457, -0.01844925301869748,
  0.016753753517151748, 0.0393436182825252, 0.006628362222399236,
  0.0031250360849192664, 0.024236083380650263, -0.0043267024182858166,
  0.01165681936586893, -0.04867141063827842},
 {0.15837771768788678, -0.00011088336830329658, -0.03604825622434168,
  0.0068141985260496175, 0.0021850907000897832, -0.019320487367611185,
  0.004794999066385206, -0.074261881799337, -0.008463426954720866,
  0.10277171685564128, -0.06232932642567465, 0.010349026955305596,
  0.04893622351930656, -0.08039533048305253, 0.01763876364729974,
  -0.0005628336326525686, 0.010919622419898661, 0.002478291892971593,
  0.006903109146312329, -0.09067633416145358},
 {-0.056267000053740766, 0.00001559611113659412, -0.06997624645407705,
  0.0010397684899343222, 0.001392599927156455, 0.08929154512726988,
  -0.0004856327306789596, 0.015782741499842823, -0.032298505419166124,
  0.08152149684959237, -0.15772352469189893, 0.035873997001771005,
  -0.04377966808848243, -0.008136900467978166, 0.08646569195993649,
  0.021399337815846648, 0.01186729713716059, 0.0039183415614166914,
  0.004328071379423944, 0.01577099304553462},
 {-0.028956762786505812, -0.006418089191279312, 0.013355331278774085,
  0.004082472534287727, -0.013017215806988454, -0.05132506920970575,
  -0.0020566757887476475, -0.002549933907223532, -0.02800075007559069,
  -0.020799456084459156, -0.045764196722543754, 0.13014953498877524,
  0.041453984348620895, 0.0032104610951075685, -0.03068344533570832,
  0.01316257816927397, 0.009397744542286122, -0.0020450408063745927,
  -0.005117254195486473, 0.021921782953487866},
 {0.11905947480828966, -0.00009122408070787313, -0.02592031519535036,
  0.0002350484193871946, -0.012917264458997395, 0.041727936507362846,
  -0.0004908453430108254, -0.02767056022553318, 0.0007959499465993049,
  -0.17267112232895548, -0.09580347391209115, -0.006248451018826487,
  0.0802168734295517, 0.03136424584246157, 0.02234649910223293,
  -0.0029782580007121943, -0.031731110466620895, 0.0018131237083419207,
  0.0065967861906554995, 0.07236668707592316},
 {-0.022195713696460062, 0.004126734170840236, 0.010930080238354666,
  -0.0016469864386048144, -0.05413030710784895, -0.05372772306304678,
  -0.001453627590607233, -0.004366764018311867, 0.005780751751248882,
  0.019350630598524297, -0.013367942472122864, -0.027476221627427855,
  -0.016768821861146848, 0.00041601740043731625, 0.12528463470256504,
  0.053964632575474694, -0.027896258902860953, 0.0006754919351719815,
  0.0012021753300676906, 0.0012992180757535352},
 {-0.011949017142319038, 0.00041124988456697607, -0.014743972951727937,
  -0.0013526659340555767, -0.04773190327121365, 0.07192322794406533,
  0.000602556718064423, 0.011991844569716286, 0.020223041841495086,
  0.05054423876172013, 0.09571173568488815, 0.006979013046540564,
  0.034597301049421623, -0.009441391996460581, -0.11090006936483317,
  -0.019733982354485806, -0.03129038972703463, -0.0005590677782725911,
  -0.007699468381066538, -0.037582280599009},
 {-0.11800275951635548, 0.00256245081420642, -0.015528201780424496,
  -0.00048230140537089297, 0.013221933827325925, -0.006005755089795161,
  -0.00036568660549255214, 0.010299348338501754, 0.0007617166832344724,
  0.024295558497521255, -0.03576972321222767, -0.0290301134958795,
  0.17666705525000023, -0.042685553399493315, 0.00641493933924015,
  0.07545403577541585, -0.048245978978344276, -0.0027713059043912524,
  -0.00557677653477524, -0.005212882602896438},
 {-0.03135660185064353, 0.0029256039204580706, 0.004210743772223673,
  -0.00037531946564787095, -0.013450526099290505, -0.01223262089998042,
  0.0009842942786490057, 0.01737456606069785, 0.0036097583208428885,
  0.004200010319660261, -0.13107035673589032, -0.02730255597380461,
  0.04153224095397977, -0.0038510269311402326, -0.02049935716317613,
  -0.08665194067345698, 0.23866749205737664, 0.002861017825952498,
  0.002540992300473039, 0.007883585982716483},
 {-0.01825616713448373, -0.0020756327284446926, -0.002595442703692251,
  0.004860692431037114, 0.00294561175495154, -0.0008213210533982405,
  0.004126158745581685, 0.03321932277488637, 0.0070398904232391495,
  0.017035413654100204, 0.08209345145157132, 0.016629730079095354,
  0.05314961976905982, 0.008338199637308747, 0.08684751009755377,
  -0.21777958762651486, -0.07117930060980879, 0.0018682147366780313,
  0.005555757278753163, -0.011002120977473849}};

static double wageigs[] =
{0, -0.2984519658202581, -0.3735877750562505,
 -0.40326342443650165, -0.4275462791078368, -0.42975546755905614,
 -0.47135015336110575, -0.5504367946172593, -0.57640185413455,
 -0.6096245220298862, -0.634319098588729, -0.6709446458122243,
 -0.7063690245467197, -0.7258254272647924, -0.7457660080667772,
 -0.7572751946958909, -0.7885280382111488, -0.8013249709506047,
 -0.816432753033377, -0.8266122814253785};

static double wagprobs[20][20] =
{{-0.08662790433139517, -0.04397200219860013, -0.03908940195447013,
  -0.057045102852255135, -0.019307800965390098, -0.03672810183640525,
  -0.05805890290294535, -0.08325180416259033, -0.02443130122156497,
  -0.04846600242330021, -0.08620900431045043, -0.062028603101430234,
  -0.019502700975135085, -0.03843190192159516, -0.04576310228815513,
  -0.06951790347589525, -0.06101270305063528, -0.014385900719295096,
  -0.035274201763710045, -0.07089560354478038},
 {-0.0353432487260441, -0.021505530758913108, -0.025932731055604143,
  -0.05545318409661715, 0.008582700769358057, -0.018812156421006438,
  -0.04558319937488951, -0.11475137880609051, -0.0025060306428045472,
  0.0562801476135858, 0.11948992035408662, -0.03794104566807277,
  0.018543172554928506, 0.08186103551389992, -0.028431648406207728,
  -0.03283433616908361, -0.014523500158627134, 0.032570521382550274,
  0.05570122133345389, 0.060589270762097726},
 {-0.015915420511329704, 0.009692435359590253, 0.00733707056430765,
  0.014516410175338501, -0.01142922097156033, 0.0014151462298009228,
  0.005558438321761724, 0.055332129270738904, 0.011976161257971412,
  -0.056817719401905414, -0.0841601100058974, 0.003642883343466666,
  -0.016812029275416453, 0.030780081054979515, -0.010686171856182163,
  0.0016494833627142328, -0.018322966527695873, 0.09200973370947656,
  0.053179212168830356, -0.07294554626898914},
 {0.013759333298633413, -0.011044774910643478, -0.01054548922245462,
  -0.024542406414697883, 0.1286385406931702, -0.014686969922713391,
  -0.022995901703596583, 0.03981546277066954, -0.013438277903075212,
  -0.0026156891434270277, -0.01719605364983678, -0.022100085463587327,
  -0.0027038562547360393, -0.02726223226367094, -0.016979508141960233,
  0.0053326765865718065, -0.0008379960574059017, 0.0184323927875773,
  -0.027060266092953242, 0.008031101008136131},
 {-0.01254519793823637, -0.0009908787652949257, 0.011299091412613578,
  0.01626061062799485, 0.03566034009996547, 0.0033827560985910813,
  0.006333750904289955, -0.00896673595046517, 0.025036217259614912,
  -0.04584199019188938, -0.06184254509645476, 0.0009491089065080568,
  -0.01344469330991452, 0.08665016158734547, -0.00966343074212289,
  0.004618005598265847, -0.011432857407903152, -0.06323491318530367,
  0.09779646621500009, -0.06002326612260447},
 {-0.0016266525745331382, -0.03571616585481501, -0.012864593388218992,
  -0.027956181739045773, -0.02381645137469793, -0.026783789261294978,
  -0.03639534743185881, 0.22793942592080588, -0.0155391138199017,
  0.02091180684719519, 0.03951311713946571, -0.04945549793708711,
  0.005337766553435219, 0.027944334318020563, -0.07575715375023316,
  -0.011634397366523292, -0.01866585157363799, -0.01569290654160444,
  0.008018105098447562, 0.02223954673608246},
 {-0.02167491927989601, 0.03126543078215943, 0.025440466494243783,
  0.05941569037933608, 0.0048103403384357245, 0.025535244710193285,
  0.04850226368389819, -0.048588408253198906, 0.013698388635919363,
  0.009424141687599114, 0.006715812916003258, 0.04890691518210074,
  0.00430914445737426, -0.01979784396879971, -0.184201351355039,
  -0.0077607359519451255, 0.0037035775397267685, 0.001262356924065289,
  -0.009639989176310145, 0.008673474254133357},
 {-0.02221551267346312, 0.12374836670233941, -0.021699849910208246,
  -0.13661033339596748, -0.0006552216949112155, 0.024585270444916665,
  -0.06339849548091075, 0.030378311586393907, 0.021988258750919438,
  -0.016118509633790558, 0.025338262967055193, 0.09802094176583749,
  0.005372099090136465, -0.007122351839115535, -0.0066637692227581044,
  -0.007835644589739501, -0.00732554509494566, -0.006507510495802753,
  -0.0017851639921132596, -0.03149360328387214},
 {-0.0916807385182919, 0.011016309459468855, -0.0020598225581001718,
  0.06709928518426166, 0.01513403947403162, 0.019842218283231915,
  0.043729114503846055, 0.03134255724369655, 0.0005758475584865584,
  -0.04218534118940628, 0.15866697238009075, 0.008368054572756483,
  0.011475556339007102, 0.026180113109177325, 0.03417746473911878,
  -0.06075996365676529, -0.0949181212384951, -0.00044801094613308067,
  -0.04529231556005072, -0.09026321917993069},
 {-0.05799954304417141, -0.012493490541584575, 0.006793981716528776,
  0.010552735764150004, 0.004332312327807966, 0.007797523165648176,
  -0.00612890630650264, 0.023117688863084383, 0.06915553458623389,
  0.0293313384996369, 0.027297592094938088, -0.028932993736102662,
  0.0040820351276770125, -0.12156087736154904, 0.01908902651720602,
  -0.04330588468449417, -0.050930111781680325, -0.0014989376655455476,
  0.09064406874102143, 0.030656907717698353},
 {-0.07439341264189382, 0.04427720500137817, -0.021561968047326237,
  0.028594181326133224, 0.0054505037891579055, 0.010619308839189996,
  0.037793443915451516, 0.026596079808236237, -0.02193683563873892,
  0.07243586108500191, -0.12747646180849487, 0.040274930922826815,
  -0.015142541442547118, 0.038528976593187395, 0.027946468726088993,
  -0.08616602330115625, -0.0871658984721852, -0.00046359573749853416,
  -0.011864713395771715, 0.11365449047896045},
 {-0.018676265992530913, -0.03032916723048719, 0.02390946837598704,
  -0.01782911279148313, -0.00010369195213233988, 0.018229248982449653,
  -0.026265592365137015, 0.003493994914378447, 0.12092493225397696,
  0.014175613261994796, -0.03932992215381625, -0.041399350796976965,
  -0.006543171718014073, 0.05346912217213576, 0.000060787295714846686,
  0.0033112912671669353, 0.005820506587576054, 0.0036491270646833718,
  -0.08456609422154902, 0.017998277046062956},
 {0.13641427702582373, -0.05607569623992714, -0.07567862880722315,
  -0.07581005560536624, -0.0016253951698452127, 0.07594399327169052,
  0.10609514139584342, -0.004275986391775505, 0.011077529691323619,
  -0.03369849883631017, 0.0014110828390904117, 0.004256412629543203,
  0.0032312078915726974, -0.0011189644241755856, -0.013253866783547516,
  -0.036508812311443976, -0.06016029122853343, 0.0010257570061342508,
  0.004741043480323465, 0.014009750566802905},
 {0.14750262415805065, 0.0911309133026857, -0.010696060780615264,
  0.053274645436451856, -0.005568584022893447, -0.04856688673265621,
  -0.04246658894913904, -0.025693701179748056, 0.014149821738870336,
  -0.0238518320717526, 0.03130454468071894, -0.07502626963344665,
  -0.039593836294283306, -0.00028981450762873234, -0.011100109630786765,
  0.022690676714141347, -0.10295386570138826, -0.0016892143324578064,
  -0.005384612345127122, 0.032828150151004966},
 {-0.032251170323834844, -0.039820199719605036, 0.021045294937284194,
  -0.02904718811733145, 0.0005253020635774123, 0.00971066636193823,
  0.011158310265606946, 0.004196029762453968, -0.005600610474861128,
  0.0030361080091000506, 0.07627526507705965, 0.052199454045061947,
  -0.12418179933961741, -0.003356542003955646, -0.0003132971003851252,
  0.007469828446236788, 0.019738442009323436, 0.0007057039178621915,
  0.0024491968863646113, 0.026061205297721265},
 {0.06244893561623596, -0.07928960485540668, 0.0837171063441727,
  -0.008668745942896044, -0.0007466305068550615, -0.016649673713913606,
  -0.07088698353000616, -0.012869118355702853, -0.006143718903716753,
  0.0018129436914273362, -0.011455847707142128, 0.125441787391439,
  0.022285373403439418, 0.0003079401959009634, 0.00017512003884978213,
  0.027204607672753695, -0.12141465537341414, 0.0013695067372830692,
  -0.002300309551164875, 0.005661967348716818},
 {-0.04712508072900232, 0.023468157192705074, 0.06240142010712506,
  -0.057138895219877486, -0.000893650204252724, 0.075894086172039,
  0.031311997790448624, -0.009092186877369823, -0.030003881385894177,
  0.06302914128271957, -0.015330492210388699, -0.09781633147000987,
  -0.004129938391497053, -0.0020107539165119047, -0.0033503702726770984,
  0.12803684997174333, -0.07496617381765575, -0.0007895004946909288,
  0.000803205648558524, -0.04229760317551147},
 {-0.054344442317237944, 0.0076062347542590865, 0.052113382806553775,
  -0.01338060412047799, -0.001841020167889566, 0.04462408290449821,
  -0.01853587256061214, 0.0008466998362577875, -0.01698687995234879,
  -0.14832784903206883, 0.011374199079884949, -0.038698474923225,
  0.013566269389026364, 0.0012744071872514385, 0.001620909199650365,
  0.000540540905888088, 0.004959358159359442, -0.0005561017266875668,
  0.0011309940790009065, 0.15301416649891747},
 {-0.07025301505041058, 0.00014556295076810773, -0.023343251086268068,
  -0.05000969932374482, -0.0014384061465977601, -0.11386504039712571,
  0.11768542466472931, -0.0020597266962605817, 0.021798453470143586,
  -0.030879385371217583, 0.00502072260921487, 0.028300880108756872,
  0.010513483575935114, -0.0015762496591778, -0.0017022305709658836,
  0.11508719160450812, -0.03754931341951792, -0.0005882734300546004,
  -0.0041161849921565455, 0.038829057159442244},
 {-0.05692477482776453,
  -0.02653319031742664, -0.11737910264279769, 0.07393240388256206,
  -0.001457629722277124, 0.05204268349655665, -0.0828431366755649,
  0.00020430846339690879, 0.004671788553548594, -0.009741060538760074,
  -0.003072722768487825, 0.039698339427595854, -0.0019739169465894726,
  -0.002115387130603613, -0.004653490839902351, 0.13421042672478148,
  -0.02359714019601924, -0.0004044808786225971, 0.0009473370451194571,
  0.024988745891255038}};

static double mtmameigs[] =
{0, -0.2961760821103565, -0.365652626837339,
 -0.38671932452970037, -0.42326849325269555, -0.4259265187114145,
 -0.46723395913267607, -0.5464912156185182, -0.5747276926396807,
 -0.6071328109720598, -0.6339632013794405, -0.6574093763937996,
 -0.7044270860238384, -0.7209073186899997, -0.7506866192057006,
 -0.7551296747258581, -0.7873932762264586, -0.810913109548552,
 -0.8186876881556857, -0.8312217474625978};

static double mtmamprobs[20][20] =
{{0.0866279043313952, 0.04397200219860026, 0.03908940195447025,
  0.05704510285225514, 0.019307800965390077, 0.0367281018364052,
  0.05805890290294506, 0.08325180416259008, 0.024431301221565265,
  0.04846600242330047, 0.0862090043104504, 0.06202860310143018,
  0.019502700975135054, 0.03843190192159521, 0.045763102288155146,
  0.06951790347589523, 0.06101270305063495, 0.014385900719294945,
  0.03527420176371021, 0.07089560354478029},
 {0.035561607230076425, 0.021452034798925875, 0.025289700297807305,
  0.05426363213057566, -0.008222771313934937, 0.018809713405152625,
  0.04525048517749938, 0.11396137747298715, 0.002269573588420383,
  -0.05370962500323136, -0.11682537170907294, 0.03784956873749698,
  -0.018090959226090976, -0.08213494648355214, 0.028286855860628388,
  0.03219538205560176, 0.015315516810597396, -0.03641081278800719,
  -0.05759474100865529, -0.057516220033223854},
 {0.013908508233029233, -0.010741058910567529, -0.007714208965670546,
  -0.015297298394271297, 0.007269236977242451, -0.0018756949033623643,
  -0.006664263825360205, -0.05683568858201999, -0.011043132925220987,
  0.05682644999974395, 0.08796840626023222, -0.004697177080427231,
  0.0172228726525516, -0.02098971126197226, 0.007846410307414477,
  -0.0029840656912848637, 0.01625626156174595, -0.09437754876112107,
  -0.046171262350368926, 0.07209296565968756},
 {-0.00974736417078596, 0.009501722363015276, 0.00803738792557657,
  0.019992975630319314, -0.133705276484346, 0.012188355967380203,
  0.01934081137991777, -0.02130857584342068, 0.010519629982552795,
  0.0064157143850252394, 0.022175620508614255, 0.01837980600721114,
  0.0036995050827059485, 0.020647226873779477, 0.012527476168274527,
  -0.0064803924513661074, 0.00012234185725716807, -0.008507305861602664,
  0.017744672681987653, -0.0015443320020960233},
 {0.017001972980605583, -0.006489906779729108, -0.014677169244502181,
  -0.02328886701554861, -0.02234431907235601, -0.008850785928660137,
  -0.014074219549985632, 0.04166084124372423, -0.0301946523316424,
  0.04940505837763448, 0.06715661004038927, -0.010997957541837291,
  0.014151027692304757, -0.08465823457868984, -0.0013575378347905377,
  -0.004854819281866914, 0.009585577318432533, 0.05806716141178032,
  -0.10143174601847862, 0.06619196611321591},
 {0.0005594056343800603, 0.03846810495302552, 0.011444860698119775,
  0.026194302421481186, 0.012403239604190925, 0.027633006762398483,
  0.03646036942777444, -0.22632388532992248, 0.013241927942499966,
  -0.0126519030297753, -0.026892304398424605, 0.05047194826407599,
  -0.0028051221154343025, -0.03964872389239331, 0.0765434455893368,
  0.009797045741462783, 0.019668413939264176, 0.020842116738761924,
  -0.022660972140598427, -0.01274527681022342},
 {-0.02138020916176656, 0.03425299345673951, 0.024153790058582224,
  0.05690061124335617, 0.004303066524553601, 0.025505194038800916,
  0.0482507607323018, -0.04549952579156671, 0.014454806196412361,
  0.009525803241913666, 0.008287879932175368, 0.05030450004402469,
  0.0045270227357393335, -0.019332947733614644, -0.18449411930725765,
  -0.010377118224483985, 0.0013477904016434739, 0.0015276819290008386,
  -0.010873853651012295, 0.008615873334457262},
 {0.031100196651222392, -0.12976272983272716, 0.02263493389126923,
  0.1296274612540156, -0.0005200921808423665, -0.023617222520153604,
  0.06286851709561977, -0.037127268321369686, -0.023181990407100086,
  0.01581920912219101, -0.03373007238524473, -0.08954171603182612,
  -0.005538475487059034, 0.004988852070652565, 0.00041515481016176714,
  0.014760563566798057, 0.01649332633447353, 0.006347670398515328,
  0.0048024236271866855, 0.033161258344216994},
 {0.0933977986651514, -0.0023762091403083255, 0.0013365608713029496,
  -0.07625410848932684, -0.014229002852796373, -0.018923156288257127,
  -0.05011703568425545, -0.033388769595753216, -0.0013562926640853774,
  0.0370897289935839, -0.15135867581356827, -0.0013749492828959036,
  -0.009968566953669395, -0.02611579119425035, -0.03704208151668012,
  0.06556910987316418, 0.0993718428782822, -0.00020237874125614145,
  0.043787598558267436, 0.08215437837735096},
 {0.0508588491496748, 0.02074929064165052, -0.009414272874378668,
  -0.0072050029432371605, -0.0029056780975801875, -0.005832860445956207,
  0.01089598428992686, -0.02148467581340314, -0.08432405046566478,
  -0.02908252531523741, -0.025629155791888698, 0.03589911036403491,
  -0.004158109843488059, 0.117564615584532, -0.016372687851348027,
  0.03689954029167945, 0.04357763294698836, 0.0010052496452285233,
  -0.07976525698973493, -0.031275996481797505},
 {0.06464821330000899, -0.045286836663020184, 0.022896515019620173,
  -0.03061399329901384, -0.004724997500200521, -0.006785048270169905,
  -0.04014230346906003, -0.025295996131222423, 0.03325886214518461,
  -0.07349325440413453, 0.12744615710956125, -0.0359545987765727,
  0.012075402272480638, -0.023149650954854488, -0.028060336091316036,
  0.08690270294395891, 0.08913316965384892, 0.00089689278536874,
  -0.0069083221755481955, -0.11684257749491975},
 {0.013188712339840179, 0.025201546418153985, -0.01547116623524057,
  0.014048232951367411, -0.0004637616612669842, -0.01296275494490237,
  0.01925668907566004, -0.004200259245120385, -0.1095595432010714,
  -0.019302206061052752, 0.06104824533764773, 0.030302612215077566,
  0.00824836617423615, -0.07171111440266659, -0.0010333159680584465,
  0.004100219597481443, 0.0009441069369101624, -0.004033691341645613,
  0.09439486033276029, -0.031995778318109944},
 {0.14297590994888154, -0.060680069216447474, -0.06973359032178301,
  -0.079385622621617, -0.0007449896720260359, 0.07692939457844014,
  0.09612418820143483, -0.005046310211767643, 0.00881332482064309,
  -0.0328952332317771, 0.00303725067794282, 0.017858974511086975,
  0.0020502868715589007, -0.0022060400797726904, -0.012470540858441098,
  -0.038547511534476046, -0.06356694815755778, 0.0010329335178927113,
  0.006782402320280527, 0.009672190457505205},
 {0.15461363123683958, 0.09796606687140999, -0.018215739459978716,
  0.05708269930294891, -0.004457887921182733, -0.05120795121552961,
  -0.030743349448867707, -0.025680743430060358, 0.013277648416397534,
  -0.02499476979565829, 0.023452872369277757, -0.09634376653153451,
  -0.023243876300254974, -0.00027382354224944546, -0.010476648413065363,
  0.010957598150794189, -0.08833475650934149, -0.0016910539222819028,
  -0.004026274488594908, 0.022340124630932986},
 {0.02932380292890195, -0.05662966832020375, 0.05692339520018425,
  -0.011678029942641017, -0.0005390228218326405, -0.025949292388766497,
  -0.04330090400031425, -0.00685318295788398, -0.0025826092550182743,
  -0.0019840557360376026, 0.05959797696140827, 0.11363016187151163,
  -0.0941597103666233, -0.0021204494101853435, -0.000591497562243158,
  0.014424533762850206, -0.05990614400933401, 0.0010052536287629345,
  -0.00046915230824770446, 0.03185859472571239},
 {-0.07127161064708971, 0.04008378242135459, -0.049505006163237684,
  -0.016180042487676606, 0.0003642467751329144, 0.03919260676511212,
  0.06590338394002404, 0.011654251492515852, -0.001575424458406114,
  0.0013775083805891326, 0.049027613056853755, -0.08793537574291099,
  -0.09003800568993192, -0.0015668629704929092, -0.001507158751259746,
  -0.0020990694072859878, 0.09442150867183564, -0.0008099928123995563,
  0.002992020995559401, 0.017471626631713626},
 {0.031827000793683266, -0.008980150796867165, -0.0814125469083036,
  0.04017629513013613, 0.0017340891665920514, -0.10103712010989731,
  0.018677421679887292, 0.010982061460000796, 0.030943297608324566,
  -0.031274338581653426, 0.014546895520865697, 0.08382029516304329,
  0.0009151409972737787, 0.0007501994623075234, 0.003987243981147214,
  -0.11566371882457122, 0.09046972657748834, 0.0005863046894871563,
  0.0008672177425119163, 0.008084685248543914},
 {-0.013252155931930161, -0.0020087005643413675, 0.030844331179362014,
  0.027207484416002296, -0.0007806321125681434, 0.05889234364898691,
  -0.07250627377161177, 0.0035140587683799244, -0.01234225184768643,
  -0.14106845444653254, 0.01145560777956954, -0.013280996346456448,
  0.011501732586922653, 0.0020526810655552194, 0.002490530126457971,
  -0.06548765996486455, 0.03345642853759085, -0.00012797423882209658,
  0.001846992102264182, 0.1375929090137219},
 {-0.07595946442342082, 0.007807949526305038, 0.01579533203463662,
  -0.06687355235759444, -0.002083298571554414, -0.08376134249484893,
  0.11563215140325152, -0.0027686944696296554, 0.009061081411616084,
  -0.07908871694199837, 0.007708359113299237, -0.0029720288262342245,
  0.015633366477761538, -0.0009759708837499167, -0.0013625200711269959,
  0.10130997497899956, -0.039905002719783866, -0.000729477240624516,
  -0.0030357030316818055, 0.08656755708637867},
 {-0.05429703937350998, -0.021867453707076184, -0.12564670875939996,
  0.07181163355889429, -0.0018167330492840166, 0.027826226325725845,
  -0.06649246159416587, -0.0005645161894281465, 0.00929303057159789,
  -0.013365448768531608, -0.002482959226404254, 0.047050626252299096,
  0.00020413104847392702, -0.0021653157344375287, -0.005541649439729806,
  0.14203499202174216, -0.03278527956210416, -0.0005241573294822634,
  0.00040891908103747474, 0.028920163873783104}};

#ifndef OLDC
/* function prototypes */
void   size_arrays(long spp, long chars);
void   protdist_inputnumbers(void);
void   codemenu(void);
void   catmenu(void);
void   getoptions(void);
void   transition(void);
void   printcategories(void);
void   inputoptions(void);
void   protdist_inputdata(void);
void   doinput(void);
void   code(void);
void   protdist_cats(void);
void   maketrans(void);
void   givens(double **, long, long, long, double, double, boolean);
void   coeffs(double, double, double *, double *, double);
void   tridiag(double **, long, double);
void   shiftqr(double **, long, double);
void   qreigen(double **, long);
void   useeigen(double (*whichprob)[20], double *whicheig);
void   predict(long, long, long);
void   makedists(void);
void   finalize_eigens(void);
void   protdistrun(void);
void   protdist(char * infilename, char * wgtsfilename, char * catsfilename, char * outfilename,
                char * outfileopt, char * Model, char * GammaDist, double FracInvar, double CoeffVar,
                int OneCat, int NumCats, double SiteRate1, double SiteRate2, double SiteRate3,
                double SiteRate4, double SiteRate5, double SiteRate6, double SiteRate7, double SiteRate8,
                double SiteRate9, int SitesWeighted, char * GeneCode, char * AACat, double ProbCat,
                double TTratio, int useEqualBF, double BaseFreqA, double BaseFreqC, double BaseFreqG,
                double BaseFreqTU, int MultData, int MultDSet, int NumSets, int InputSeq, int PrintData,
                int DotDiff, int PrintInd);
/* function prototypes */
#endif


void size_arrays(long spp, long chars)
{
  /* Allocate, resize, or free arrays and matrices sized by spp and chars. If both spp and
   * chars are 0, frees all arrays. Affected matrices: gnode, d, nayme,
   * weight, oldweight, category */

  static long curspp = 0;
  static long curchars = 0;
  long i;

  assert( (spp > 0 && chars > 0)
          || (spp == 0 && chars == 0) );

  if ( chars != curchars || spp != curspp ) {
    if ( curspp > 0 )
      for (i = 0; i < curspp; i++)
        free(gnode[i]);

    if ( spp != curspp ) {
      if ( curspp > 0 ) {
        for (i = 0; i < curspp; i++)
          free(d[i]);
        free(d);
        free(nayme);
        free(gnode);
      }

      if ( spp > 0 ) {
        d      = (double **)Malloc(spp * sizeof(double *));
        for (i = 0; i < spp; ++i)
          d[i] = (double *)Malloc(spp * sizeof(double));

        nayme  = (naym *)Malloc(spp * sizeof(naym));
        gnode = (aas **)Malloc(spp * sizeof(aas *));
      }
      else {
        d = NULL;
        nayme = NULL;
        gnode = NULL;
      }
    }
    if ( chars != curchars ) {
      if ( curchars > 0 ) {
        free(weight);
        free(oldweight);
        free(category);
      }

      if ( chars > 0 ) {
        weight = (steparray)Malloc(chars * sizeof(long));
        oldweight = (steparray)Malloc(chars * sizeof(long));
        category = (steparray)Malloc(chars * sizeof(long));
      }
      else {
        weight = NULL;
        oldweight = NULL;
        category = NULL;
      }
    }

    if ( gnode != NULL ) {
      for (i = 0; i < spp; i++)
        gnode[i] = (aas *)Malloc(chars * sizeof(aas ));
    }
  }

  curchars = chars;
  curspp   = spp;
}


void protdist_inputnumbers(void)
{
  /* input the numbers of species and of characters */
  if ( fscanf(infile, "%ld%ld", &spp, &chars) != 2
       || spp <= 0 || chars <= 0 ) {
    printf("Error in input file %s: unable to read number of species and characters\n"
           "before dataset %ld. Please refer to the documentation for correct input file\n"
           "format.\n\n", infilename, ith);
    exxit(-1);
  }

  if (printdata) {
    fprintf(outfile, "\nProtein sequence distance matrix, version %s\n\n", VERSION);
    fprintf(outfile, "%2ld species, %3ld  positions\n\n", spp, chars);
  }
  size_arrays(spp, chars);

}  /* protdist_inputnumbers */


void codemenu(void)
{
  /* Display the genetic code selection menu and accept input. `whichcode' is
   * set appropriately. Function will not return until valid input is received.
   * exxit() is called after too many failures. */

  long loopcount2 = 0;
  bool done = false;
  char ch;

  printf("Which genetic code?\n");
  printf(" type         for\n\n");
  printf("   U           Universal\n");
  printf("   M           Mitochondrial\n");
  printf("   V           Vertebrate mitochondrial\n");
  printf("   F           Fly mitochondrial\n");
  printf("   Y           Yeast mitochondrial\n\n");

  while ( !done) {
    printf("type U, M, V, F, or Y\n");
    if ( !(ch = menu_getchar()) )
      continue;
    countup(&loopcount2, 10);
    switch (ch)
    {
      case 'U':
        whichcode = universal;
        done = true;
        break;

      case 'M':
        whichcode = mito;
        done = true;
        break;

      case 'V':
        whichcode = vertmito;
        done = true;
        break;

      case 'F':
        whichcode = flymito;
        done = true;
        break;

      case 'Y':
        whichcode = yeastmito;
        done = true;
        break;

      default:
        done = false;
        /* Keep going */
    }
  }
}


void catmenu(void)
{
  /* Display the categorization selection menu and accept input. `whichcat' is
   * set appropriately. Function will not return until valid input is received.
   * exxit() is called after too many failures. */

  long loopcount2 = 0;
  bool done = false;
  char ch;

  printf("Which of these categorizations of amino acids do you want to use:\n"
         "\n"
         " all have groups: (Glu Gln Asp Asn), (Lys Arg His), (Phe Tyr Trp)\n"
         " plus:\n"
         "George/Hunt/Barker: (Cys), (Met   Val  Leu  Ileu), (Gly  Ala  Ser  Thr    Pro)\n"
         "Chemical:           (Cys   Met), (Val  Leu  Ileu    Gly  Ala  Ser  Thr), (Pro)\n"
         "Hall:               (Cys), (Met   Val  Leu  Ileu), (Gly  Ala  Ser  Thr), (Pro)\n"
         "\n"
         "Which do you want to use? ");

  while (!done) {
    printf("(type G, C, or H)\n");
    if ( !(ch = menu_getchar()) )
      continue;
    countup(&loopcount2, 10);
    switch (ch)
    {
      case 'C':
        whichcat = chemical;
        done = true;
        break;

      case 'H':
        whichcat = hall;
        done = true;
        break;

      case 'G':
        whichcat = george;
        done = true;
        break;
    }
  }
}


void getoptions(void)
{
  /* interactively set options */
  long loopcount, loopcount2;
  Char ch, ch2;
  bool done = false, ok = false;
  char *str;
  lower = false;

  if (printdata)
    fprintf(outfile, "\nProtein distance algorithm, version %s\n\n", VERSION);
  putchar('\n');

  loopcount = 0;
  do {
    /* Display menu */
    cleerhome();
    printf("\nProtein distance algorithm, version %s\n\n", VERSION);
    printf("Settings for this run:\n");
    switch (method)
    {
      case jtt:
        str = "Jones-Taylor-Thornton matrix";
        break;
      case pmb:
        str = "Henikoff/Tillier PMB matrix";
        break;
      case pam:
        str = "Dayhoff PAM matrix";
        break;
      case mtrev:
        str = "Mitochondrial protein (mtRev) matrix";
        break;
      case wag:
        str = "Whelan and Goldman (WAG) matrix";
        break;
      case mtmam:
        str = "Mammalian mitochondrial (mtMam) matrix";
        break;
      case kimura:
        str = "Kimura formula";
        break;
      case similarity:
        str = "Similarity table";
        break;
      case categories:
        str = "Categories model";
        break;
      default: /* Shouldn't happen */
        assert(0);
        str = "(unknown)";
    }
    printf("  P  Use JTT, PMB, PAM, Kimura, categories model?  %s\n", str);
    if ( !(method & (kimura|similarity) ) ) {
      printf("  G  Gamma distribution of rates among positions?");
      if (gama)
        printf("  Yes\n");
      else if (invar)
        printf("  Gamma+Invariant\n");
      else
        printf("  No\n");
    }
    printf("  C           One category of substitution rates?");
    if (!ctgry || categs == 1)
      printf("  Yes\n");
    else
      printf("  %ld categories\n", categs);
    printf("  W                    Use weights for positions?");
    if (weights)
      printf("  Yes\n");
    else
      printf("  No\n");
    if ( method == categories ) {
      printf("  U                       Use which genetic code?  %s\n",
             (whichcode == universal) ? "Universal"                  :
             (whichcode == ciliate)   ? "Ciliate"                    :
             (whichcode == mito)      ? "Universal mitochondrial"    :
             (whichcode == vertmito)  ? "Vertebrate mitochondrial"   :
             (whichcode == flymito)   ? "Fly mitochondrial"          :
             (whichcode == yeastmito) ? "Yeast mitochondrial" : "(unknown)");
      printf("  A          Which categorization of amino acids?  %s\n",
             (whichcat == chemical) ? "Chemical"              :
             (whichcat == george)   ? "George/Hunt/Barker"    :
             (whichcat == hall)     ? "Hall" : "(unknown)" /* shouldn't happen */ );

      printf("  E              Prob change category (1.0=easy):%8.4f\n", ease);
      printf("  T                Transition/transversion ratio:%7.3f\n", ttratio);
      printf("  F                             Base Frequencies:");
      if (basesequal)
        printf("  Equal\n");
      else
        printf("%7.3f%6.3f%6.3f%6.3f\n", freqa, freqc, freqg, freqt);
    }
    printf("  L                      Form of distance matrix?  %s\n", lower ? "Lower-triangular" : "Square");
    printf("  M                   Analyze multiple data sets?");
    if (mulsets)
      printf("  Yes, %2ld %s\n", datasets, (justwts ? "sets of weights" : "data sets"));
    else
      printf("  No\n");
    printf("  I                  Input sequences interleaved?  %s\n", (interleaved ? "Yes" : "No, sequential"));
    printf("  0                 Terminal type (IBM PC, ANSI)?  %s\n", ibmpc ? "IBM PC" : ansi  ? "ANSI"   : "(none)");
    printf("  1           Print out the data at start of run?  %s\n", (printdata ? "Yes" : "No"));
    printf("  2         Print indications of progress of run?  %s\n", progress ? "Yes" : "No");

    /* Prompt for input */
    printf("\nAre these settings correct? (type Y or the letter for one to change)\n");
    if ( !(ch = menu_getchar()) )
      continue;

    /* Handle input */
    ok = true;
    switch (ch)
    {
      case 'P':
        switch (method)
        {
          case jtt:
            method = pmb;
            break;
          case pmb:
            method = pam;
            break;
          case pam:
            method = mtrev;
            break;
          case mtrev:
            method = wag;
            break;
          case wag:
            method = mtmam;
            break;
          case mtmam:
            method = kimura;
            break;
          case kimura:
            method = similarity;
            break;
          case similarity:
            method = categories;
            break;
          case categories:
            method = jtt;
            break;
          default: /* Shouldn't happen */
            assert(0);
            method = jtt;
        }
        break;

      case 'G':
        if (method & (kimura|similarity))
        {
          ok = false;
          break;
        }
        /* One category: Yes -> Gamma -> Gamma+Invar -> Yes */
        if (!gama && !invar)
        {
          gama = true;
          invar = false;
        }
        else if (gama)
        {
          gama = false;
          invar = true;
        }
        else if (invar)
        {
          gama = false;
          invar = false;
        }
        else { /* Shouldn't happen */
          assert(0);
          gama = false;
          invar = false;
        }
        break;

      case 'C':
        ctgry = !ctgry;
        if (ctgry) {
          initcatn(&categs);
          initcategs(categs, rate);
        }
        break;

      case 'W':
        weights = !weights;
        break;

      case 'U':
        if ( method != categories )
        {
          ok = false;
          break;
        }
        codemenu();
        break;

      case 'A':
        if ( method != categories )
        {
          ok = false;
          break;
        }
        catmenu();
        break;

      case 'E':
        if ( method != categories )
        {
          ok = false;
          break;
        }
        loopcount2 = 0;
        for (;;) {
          printf("Ease of changing category of amino acid?\n");
          printf("  Enter a number between 0.0 (not easy) and 1.0 (no difficulty):\n");
          fflush(stdout);
          str = fgetline(stdin);
          if (sscanf(str, "%lf", &ease) == 1)
            if (0.0 <= ease && ease <= 1.0)
              break;
          countup(&loopcount2, 10);
        }
        break;

      case 'T':
        if (method != categories)
        {
          ok = false;
          break;
        }
        loopcount2 = 0;
        for (;;) {
          printf("Transition/transversion ratio?\n");
          fflush(stdout);
          str = fgetline(stdin);
          if (sscanf(str, "%lf", &ttratio) == 1)
            if (ttratio >= 0.0)
              break;
          countup(&loopcount2, 10);
        }
        break;

      case 'F':
        if (method != categories)
        {
          ok = false;
          break;
        }
        basesequal = !basesequal;
        if ( basesequal )
        {
          freqa = freqc = freqg = freqt = 0.25;
        }
        else
        {
          initfreqs(&freqa, &freqc, &freqg, &freqt);
        }
        break;

      case 'L':
        lower = !lower;
        break;

      case 'M':
        mulsets = !mulsets;
        if (mulsets)
        {
          printf("Multiple data sets or multiple weights?");
          loopcount2 = 0;
          for (;;) {
            printf(" (type D or W)\n");
            fflush(stdout);
            if ( (ch2 = menu_getchar()) )
              if ( ch2 == 'W' || ch2 == 'D' )
                break;
            countup(&loopcount2, 10);
          };
          justwts = (ch2 == 'W');
          if (justwts)
            justweights(&datasets);
          else
            initdatasets(&datasets);
        }
        else
        {
          /* FIXME: Disable multiple data sets */
        }
        break;

      case 'I':
        interleaved = !interleaved;
        break;

      case '0':
        if (ibmpc)
        {
          ibmpc = false;
          ansi = true;
        }
        else if (ansi)
          ansi = false;
        else
          ibmpc = true;
        break;

      case '1':
        printdata = !printdata;
        break;

      case '2':
        progress = !progress;
        break;

      case 'Y':
        done = true;
        break;

      default:
        ok = false;
    }
    if ( !ok )
    {
      if (strchr("CUAPGETFLMWI120", ch) == NULL)
        printf("Not a possible option!\n");
      else
        printf("That option not allowed with these settings\n");
      printf("\nPress Enter or Return key to continue\n");
      fflush(stdout);
      fgetline(stdin);
      countup(&loopcount, 100);
    }
  } while (!done);

  if (gama || invar)
  {
    loopcount = 0;
    for (;;) {
      printf("\n"
             "Coefficient of variation of substitution rate among positions (must be positive)\n"
             " In gamma distribution parameters, this is 1/(square root of alpha)\n" );
      fflush(stdout);
      str = fgetline(stdin);
      if ( sscanf(str, "%lf", &cvi) == 1 )
        if (cvi > 0.0)
          break;
      countup(&loopcount, 10);
    }
    cvi = 1.0 / (cvi * cvi);
  }
  if (invar) {
    loopcount = 0;
    for (;;) {
      printf("Fraction of invariant positions?\n");
      fflush(stdout);
      str = fgetline(stdin);
      if ( sscanf(str, "%lf", &invarfrac) == 1 )
        if ( 0.0 < invarfrac && invarfrac < 1.0 )
          break;
      countup (&loopcount, 10);
    }
  }
}  /* getoptions */


void transition(void)
{
  /* calculations related to transition-transversion ratio */
  double aa, bb, freqr, freqy, freqgr, freqty;

  freqr = freqa + freqg;
  freqy = freqc + freqt;
  freqgr = freqg / freqr;
  freqty = freqt / freqy;
  aa = ttratio * freqr * freqy - freqa * freqg - freqc * freqt;
  bb = freqa * freqgr + freqc * freqty;
  xi = aa / (aa + bb);
  xv = 1.0 - xi;
  if (xi <= 0.0 && xi >= -epsilon)
    xi = 0.0;
  if (xi < 0.0)
  {
    printf("THIS TRANSITION-TRANSVERSION RATIO IS IMPOSSIBLE WITH");
    printf(" THESE BASE FREQUENCIES\n");
    exxit(-1);}
}  /* transition */


void printcategories(void)
{ /* print out list of categories of positions */
  long i, j;

  fprintf(outfile, "Rate categories\n\n");
  for (i = 1; i <= nmlngth + 3; i++)
    putc(' ', outfile);
  for (i = 1; i <= chars; i++) {
    fprintf(outfile, "%ld", category[i - 1]);
    if (i % 60 == 0) {
      putc('\n', outfile);
      for (j = 1; j <= nmlngth + 3; j++)
        putc(' ', outfile);
    } else if (i % 10 == 0)
      putc(' ', outfile);
  }
  fprintf(outfile, "\n\n");
}  /* printcategories */


void inputoptions(void)
{ /* input the information on the options */
  long i;

  if (!firstset && !justwts) {
    samenumsp(&chars, ith);
    size_arrays(spp, chars);
  }

  if (firstset || !justwts) {
    for (i = 0; i < chars; i++) {
      category[i] = 1;
      oldweight[i] = 1;
      weight[i] = 1;
    }
  }
  /*  if (!justwts && weights) {*/
  if (justwts || weights)
    inputweights(chars, oldweight, &weights);
  if (printdata)
    putc('\n', outfile);
  if (method == similarity)
    fprintf(outfile, "  \n  Table of similarity between sequences\n");
  else if (printdata) {
    switch (method)
    {
      case jtt:
        fprintf(outfile, "  Jones-Taylor-Thornton model distance\n");
        break;
      case pmb:
        fprintf(outfile, "  Henikoff/Tillier PMB model distance\n");
        break;
      case pam:
        fprintf(outfile, "  Dayhoff PAM model distance\n");
        break;
      case mtrev:
        fprintf(outfile, "  mtRev model distance\n");
        break;
      case wag:
        fprintf(outfile, "  Whelan and Goldman (WAG) model distance\n");
        break;
      case mtmam:
        fprintf(outfile, "  mtMam model distance\n");
        break;
      case kimura:
        fprintf(outfile, "  Kimura protein distance\n");
        break;
      case categories:
        fprintf(outfile, "  Categories model distance\n");
        break;
      default:
        assert(0);
    }
  }
  if ((ctgry && categs > 1) && (firstset || !justwts)) {
    inputcategs(0, chars, category, categs, "ProtDist");
    if (printdata)
      printcategs(outfile, chars, category, "Position categories");
  } else if (printdata && (categs > 1)) {
    fprintf(outfile, "\nPosition category   Rate of change\n\n");
    for (i = 1; i <= categs; i++)
      fprintf(outfile, "%15ld%13.3f\n", i, rate[i - 1]);
    putc('\n', outfile);
    printcategories();
  }
  if (weights && printdata)
    printweights(outfile, 0, chars, oldweight, "Positions");
}  /* inputoptions */


void protdist_inputdata(void)
{
  /* input the names and sequences for each species */
  long i, j, k, l, aasread=0, aasnew=0;
  Char charstate;
  boolean allread, done;
  aas aa=0;   /* temporary amino acid for input */

  if (progress)
  {
    sprintf(progbuf, "\n");
    print_progress(progbuf);
  }
  j = nmlngth + (chars + (chars - 1) / 10) / 2 - 5;
  if (j < nmlngth - 1)
    j = nmlngth - 1;
  if (j > 37)
    j = 37;
  if (printdata) {
    fprintf(outfile, "\nName");
    for (i = 1; i <= j; i++)
      putc(' ', outfile);
    fprintf(outfile, "Sequences\n");
    fprintf(outfile, "----");
    for (i = 1; i <= j; i++)
      putc(' ', outfile);
    fprintf(outfile, "---------\n\n");
  }
  aasread = 0;
  allread = false;
  while (!(allread)) {
    /* eat white space -- if the separator line has spaces on it*/
    do {
      charstate = gettc(infile);
    } while (charstate == ' ' || charstate == '\t');
    ungetc(charstate, infile);
    if (eoln(infile))
      scan_eoln(infile);
    i = 1;
    while (i <= spp) {
      if ((interleaved && aasread == 0) || !interleaved)
        initname(i-1);
      if (interleaved)
        j = aasread;
      else
        j = 0;
      done = false;
      while (((!done) && (!(eoln(infile) || eoff(infile))))) {
        if (interleaved)
          done = true;
        while (((j < chars) & (!(eoln(infile) | eoff(infile))))) {
          charstate = gettc(infile);
          if (charstate == '\n' || charstate == '\t')
            charstate = ' ';
          if (charstate == ' ' || (charstate >= '0' && charstate <= '9'))
            continue;
          charstate = toupper(charstate);
          if ((!isalpha(charstate) && charstate != '.' && charstate != '?' &&
               charstate != '-' && charstate != '*') || charstate == 'J' ||
              charstate == 'O' || charstate == 'U' || charstate == '.')
          {
            printf("ERROR -- bad amino acid: %c at position %ld of species %3ld\n",
                   charstate, j, i);
            if (charstate == '.')
            {
              printf("         Periods (.) may not be used as gap characters.\n");
              printf("         The correct gap character is (-).\n");
            }
            exxit(-1);
          }
          j++;

          switch (charstate)
          {
            case 'A':
              aa = ala;
              break;

            case 'B':
              aa = asx;
              break;

            case 'C':
              aa = cys;
              break;

            case 'D':
              aa = asp;
              break;

            case 'E':
              aa = glu;
              break;

            case 'F':
              aa = phe;
              break;

            case 'G':
              aa = gly;
              break;

            case 'H':
              aa = his;
              break;

            case 'I':
              aa = ileu;
              break;

            case 'K':
              aa = lys;
              break;

            case 'L':
              aa = leu;
              break;

            case 'M':
              aa = met;
              break;

            case 'N':
              aa = asn;
              break;

            case 'P':
              aa = pro;
              break;

            case 'Q':
              aa = gln;
              break;

            case 'R':
              aa = arg;
              break;

            case 'S':
              aa = ser;
              break;

            case 'T':
              aa = thr;
              break;

            case 'V':
              aa = val;
              break;

            case 'W':
              aa = trp;
              break;

            case 'X':
              aa = unk;
              break;

            case 'Y':
              aa = tyr;
              break;

            case 'Z':
              aa = glx;
              break;

            case '*':
              aa = stop;
              break;

            case '?':
              aa = quest;
              break;

            case '-':
              aa = del;
              break;
          }
          gnode[i - 1][j - 1] = aa;
        }
        if (interleaved)
          continue;
        if (j < chars)
          scan_eoln(infile);
        else if (j == chars)
          done = true;
      }
      if (interleaved && i == 1)
        aasnew = j;
      scan_eoln(infile);
      if ((interleaved && j != aasnew) || ((!interleaved) && j != chars))
      {
        printf("ERROR:  SEQUENCES OUT OF ALIGNMENT.\n");
        exxit(-1);}
      i++;
    }
    if (interleaved) {
      aasread = aasnew;
      allread = (aasread == chars);
    } else
      allread = (i > spp);
  }
  checknames(spp);                      // Check NAYME array for duplicates.

  if ( printdata)
  {
    for (i = 1; i <= ((chars - 1) / 60 + 1); i++)
    {
      for (j = 1; j <= spp; j++)
      {
        for (k = 0; k < nmlngth; k++)
          putc(nayme[j - 1][k], outfile);
        fprintf(outfile, "   ");
        l = i * 60;
        if (l > chars)
          l = chars;
        for (k = (i - 1) * 60 + 1; k <= l; k++)
        {
          if (j > 1 && gnode[j - 1][k - 1] == gnode[0][k - 1])
            charstate = '.';
          else
          {
            switch (gnode[j - 1][k - 1])
            {
              case ala:
                charstate = 'A';
                break;

              case asx:
                charstate = 'B';
                break;

              case cys:
                charstate = 'C';
                break;

              case asp:
                charstate = 'D';
                break;

              case glu:
                charstate = 'E';
                break;

              case phe:
                charstate = 'F';
                break;

              case gly:
                charstate = 'G';
                break;

              case his:
                charstate = 'H';
                break;

              case ileu:
                charstate = 'I';
                break;

              case lys:
                charstate = 'K';
                break;

              case leu:
                charstate = 'L';
                break;

              case met:
                charstate = 'M';
                break;

              case asn:
                charstate = 'N';
                break;

              case pro:
                charstate = 'P';
                break;

              case gln:
                charstate = 'Q';
                break;

              case arg:
                charstate = 'R';
                break;

              case ser:
                charstate = 'S';
                break;

              case thr:
                charstate = 'T';
                break;

              case val:
                charstate = 'V';
                break;

              case trp:
                charstate = 'W';
                break;

              case tyr:
                charstate = 'Y';
                break;

              case glx:
                charstate = 'Z';
                break;

              case del:
                charstate = '-';
                break;

              case stop:
                charstate = '*';
                break;

              case unk:
                charstate = 'X';
                break;

              case quest:
                charstate = '?';
                break;

              default:        /*cases ser1 and ser2 cannot occur*/
                break;
            }
          }
          putc(charstate, outfile);
          if (k % 10 == 0 && k % 60 != 0)
            putc(' ', outfile);
        }
        putc('\n', outfile);
      }
      putc('\n', outfile);
    }
    putc('\n', outfile);
  }
  if (printdata)
    putc('\n', outfile);
}  /* protdist_inputdata */


void doinput(void)
{ /* reads the input data */
  long i;
  double sumrates, weightsum;

  inputoptions();
  if(!justwts || firstset)
    protdist_inputdata();
  if (!ctgry) {
    categs = 1;
    rate[0] = 1.0;
  }
  weightsum = 0;
  for (i = 0; i < chars; i++)
    weightsum += oldweight[i];
  sumrates = 0.0;
  for (i = 0; i < chars; i++)
    sumrates += oldweight[i] * rate[category[i] - 1];
  for (i = 0; i < categs; i++)
    rate[i] *= weightsum / sumrates;
}  /* doinput */


void code(void)
{
  /* make up translation table of the code 0123 <=> UCAG */
  long n;
  aas b;

  /* Alter genetic code if using mitochondrial sequences */
  switch (whichcode)
  {
    case universal:
      /* no change */
      break;
    case mito:
      trans[0][3][2] = trp;
      break;
    case vertmito:
      trans[0][3][2] = trp;
      trans[2][3][2] = stop;
      trans[2][3][3] = stop;
      trans[2][0][2] = met;
      break;
    case flymito:
      trans[0][3][2] = trp;
      trans[2][0][2] = met;
      trans[2][3][2] = ser;
      break;
    case yeastmito:
      trans[0][3][2] = trp;
      trans[1][0][2] = thr;
      trans[2][0][2] = met;
      break;
    case ciliate:
      /* not used */
      break;
    default:
      assert(0);        /* Shouldn't happen */
  }

  n = 0;
  for (b = ala; b <= val; b++) {
    if (b == ser2) continue;
    n++;
    numaa[b] = n;
  }
  numaa[ser] = ser1 + 1;
}  /* code */


void protdist_cats(void)
{
  /* define categories of amino acids */
  aas b;

  /* fundamental subgroups */
  cat[0] = 1;                        /* for alanine */
  cat[(long)cys - (long)ala] = 1;
  cat[(long)met - (long)ala] = 2;
  cat[(long)val - (long)ala] = 3;
  cat[(long)leu - (long)ala] = 3;
  cat[(long)ileu - (long)ala] = 3;
  cat[(long)gly - (long)ala] = 4;
  cat[0] = 4;
  cat[(long)ser - (long)ala] = 4;
  cat[(long)thr - (long)ala] = 4;
  cat[(long)pro - (long)ala] = 5;
  cat[(long)phe - (long)ala] = 6;
  cat[(long)tyr - (long)ala] = 6;
  cat[(long)trp - (long)ala] = 6;
  cat[(long)glu - (long)ala] = 7;
  cat[(long)gln - (long)ala] = 7;
  cat[(long)asp - (long)ala] = 7;
  cat[(long)asn - (long)ala] = 7;
  cat[(long)lys - (long)ala] = 8;
  cat[(long)arg - (long)ala] = 8;
  cat[(long)his - (long)ala] = 8;
  if (whichcat == george) {
    /* George, Hunt and Barker: sulfhydryl, small hydrophobic, small hydrophilic,
                                aromatic, acid/acid-amide/hydrophilic, basic */
    for (b = ala; (long)b <= (long)val; b = (aas)((long)b + 1)) {
      if (cat[(long)b - (long)ala] == 3)
        cat[(long)b - (long)ala] = 2;
      if (cat[(long)b - (long)ala] == 5)
        cat[(long)b - (long)ala] = 4;
    }
  }
  if (whichcat == chemical) {
    /* Conn and Stumpf:  monoamino, aliphatic, heterocyclic,
                         aromatic, dicarboxylic, basic */
    for (b = ala; (long)b <= (long)val; b = (aas)((long)b + 1)) {
      if (cat[(long)b - (long)ala] == 2)
        cat[(long)b - (long)ala] = 1;
      if (cat[(long)b - (long)ala] == 4)
        cat[(long)b - (long)ala] = 3;
    }
  }
  /* Ben Hall's personal opinion */
  if (whichcat != hall)
    return;
  for (b = ala; (long)b <= (long)val; b = (aas)((long)b + 1)) {
    if (cat[(long)b - (long)ala] == 3)
      cat[(long)b - (long)ala] = 2;
  }
}  /* protdist_cats */


void maketrans(void)
{
  /* Make up transition probability matrix from code and category tables */
  long i, j, k, m, n, s, nb1, nb2;
  double x, sum;
  long sub[3], newsub[3];
  double f[4], g[4];
  aas b1, b2;

  assert( prob == NULL );
  prob = Malloc(20 * sizeof(double *));

  for (i = 0; i < 20; i++) {
    pie[i] = 0.0;
    prob[i] = Malloc(20 * sizeof(double));
    for (j = 0; j < 20; j++)
      prob[i][j] = 0.0;
  }
  f[0] = freqt;
  f[1] = freqc;
  f[2] = freqa;
  f[3] = freqg;
  g[0] = freqc + freqt;
  g[1] = freqc + freqt;
  g[2] = freqa + freqg;
  g[3] = freqa + freqg;

  fracchange =   xi * (   2 * f[0] * f[1] / g[0]
                        + 2 * f[2] * f[3] / g[2]  )
               + xv * (1 - freqt*freqt - freqc*freqc
                         - freqa*freqa - freqg*freqg);
  sum = 0.0;
  for (i = 0; i <= 3; i++) {
    for (j = 0; j <= 3; j++) {
      for (k = 0; k <= 3; k++) {
        if (trans[i][j][k] != stop)
          sum += f[i] * f[j] * f[k];
      }
    }
  }
  for (i = 0; i <= 3; i++) {
    sub[0] = i + 1;
    for (j = 0; j <= 3; j++) {
      sub[1] = j + 1;
      for (k = 0; k <= 3; k++) {
        sub[2] = k + 1;
        b1 = trans[i][j][k];
        for (m = 0; m <= 2; m++) {
          s = sub[m];
          for (n = 1; n <= 4; n++) {
            memcpy(newsub, sub, sizeof(long) * 3L);
            newsub[m] = n;
            x = f[i] * f[j] * f[k] / (3.0 * sum);
            if (((s == 1 || s == 2) && (n == 3 || n == 4)) ||
                ((n == 1 || n == 2) && (s == 3 || s == 4)))
              x *= xv * f[n - 1];
            else
              x *= xi * f[n - 1] / g[n - 1] + xv * f[n - 1];
            b2 = trans[newsub[0] - 1][newsub[1] - 1][newsub[2] - 1];
            if (b1 != stop) {
              nb1 = numaa[(long)b1 - (long)ala];
              pie[nb1 - 1] += x;
              if (b2 != stop) {
                nb2 = numaa[(long)b2 - (long)ala];
                if (cat[(long)b1 - (long)ala] != cat[(long)b2 - (long)ala]) {
                  prob[nb1 - 1][nb2 - 1] += x * ease;
                  prob[nb1 - 1][nb1 - 1] += x * (1.0 - ease);
                } else
                  prob[nb1 - 1][nb2 - 1] += x;
              } else
                prob[nb1 - 1][nb1 - 1] += x;
            }
          }
        }
      }
    }
  }
  for (i = 0; i <= 19; i++)
    prob[i][i] -= pie[i];
  for (i = 0; i <= 19; i++) {
    for (j = 0; j <= 19; j++)
      prob[i][j] /= sqrt(pie[i] * pie[j]);
  }
  /* computes pi^(1/2)*B*pi^(-1/2)  */
}  /* maketrans */


void givens(double **prob, long i, long j, long n, double ctheta,
            double stheta, boolean left)
{ /* Givens transform at i, j for 1..n with angle theta */
  long k;
  double d;

  for (k = 0; k < n; k++) {
    if (left) {
      d = ctheta * prob[i - 1][k] + stheta * prob[j - 1][k];
      prob[j - 1][k] = ctheta * prob[j - 1][k] - stheta * prob[i - 1][k];
      prob[i - 1][k] = d;
    } else {
      d = ctheta * prob[k][i - 1] + stheta * prob[k][j - 1];
      prob[k][j - 1] = ctheta * prob[k][j - 1] - stheta * prob[k][i - 1];
      prob[k][i - 1] = d;
    }
  }
}  /* givens */


void coeffs(double x, double y, double *c, double *s, double accuracy)
{ /* compute cosine and sine of theta */
  double root;

  root = sqrt(x * x + y * y);
  if (root < accuracy) {
    *c = 1.0;
    *s = 0.0;
  } else {
    *c = x / root;
    *s = y / root;
  }
}  /* coeffs */


void tridiag(double **prob, long n, double accuracy)
{
  /* Givens tridiagonalization */
  long i, j;
  double s, c;

  for (i = 2; i < n; i++) {
    for (j = i + 1; j <= n; j++) {
      coeffs(prob[i - 2][i - 1], prob[i - 2][j - 1], &c, &s, accuracy);
      givens(prob, i, j, n, c, s, true);
      givens(prob, i, j, n, c, s, false);
      givens(eigvecs, i, j, n, c, s, true);
    }
  }
}  /* tridiag */


void shiftqr(double **prob, long n, double accuracy)
{ /* QR eigenvalue-finder */
  long i, j;
  double approx, s, c, d, TEMP, TEMP1;

  for (i = n; i >= 2; i--) {
    do {
      TEMP = prob[i - 2][i - 2] - prob[i - 1][i - 1];
      TEMP1 = prob[i - 1][i - 2];
      d = sqrt(TEMP * TEMP + TEMP1 * TEMP1);
      approx = prob[i - 2][i - 2] + prob[i - 1][i - 1];
      if (prob[i - 1][i - 1] < prob[i - 2][i - 2])
        approx = (approx - d) / 2.0;
      else
        approx = (approx + d) / 2.0;
      for (j = 0; j < i; j++)
        prob[j][j] -= approx;
      for (j = 1; j < i; j++) {
        coeffs(prob[j - 1][j - 1], prob[j][j - 1], &c, &s, accuracy);
        givens(prob, j, j + 1, i, c, s, true);
        givens(prob, j, j + 1, i, c, s, false);
        givens(eigvecs, j, j + 1, n, c, s, true);
      }
      for (j = 0; j < i; j++)
        prob[j][j] += approx;
    } while (fabs(prob[i - 1][i - 2]) > accuracy);
  }
}  /* shiftqr */


void qreigen(double **prob, long n)
{ /* QR eigenvector/eigenvalue method for symmetric matrix */
  double accuracy = 1.0e-6;
  long i, j;

  assert(eigvecs == NULL);
  eigvecs = Malloc(n * sizeof(double *));
  for (i = 0; i < n; i++) {
    eigvecs[i] = Malloc(n * sizeof(double));
    for (j = 0; j < n; j++) {
      if (i == j)
        eigvecs[i][j] = 1.0;
      else
        eigvecs[i][j] = 0.0;
    }
  }

  tridiag(prob, n, accuracy);
  shiftqr(prob, n, accuracy);

  assert(eig == NULL);
  eig = Malloc(n * sizeof(double));
  for (i = 0; i < n; i++)
    eig[i] = prob[i][i];
  for (i = 0; i <= 19; i++) {
    for (j = 0; j <= 19; j++)
      prob[i][j] = sqrt(pie[j]) * eigvecs[i][j];
  }
  /* prob[i][j] is the value of U' times pi^(1/2) */
}  /* qreigen */


void useeigen(double (*whichprob)[20], double *whicheig)
{
  /* Select precomputed eigenanalysis for JTT, PMB, PAM */
  int i;

  assert(method & (jtt|pmb|pam|mtrev|wag|mtmam));
  assert(prob == NULL);
  assert(eig == NULL);
  prob = Malloc(20 * sizeof(double *));
  for (i = 0; i < 20; i++)
    prob[i] = &(whichprob[i][0]);
  eig = whicheig;
}  /* useeigen */


void predict(long nb1, long nb2, long cat)
{ /* make contribution to prediction of this aa pair */
  long m;
  double TEMP;

  for (m = 0; m <= 19; m++) {
    if (gama || invar)
      elambdat = exp(-cvi*log(1.0-rate[cat-1]*tt*(eig[m]/(1.0-invarfrac))/cvi));
    else
      elambdat = exp(rate[cat-1]*tt * eig[m]);
    q = prob[m][nb1 - 1] * prob[m][nb2 - 1] * elambdat;
    p += q;
    if (!gama && !invar)
      dp += rate[cat-1]*eig[m] * q;
    else
      dp += (rate[cat-1]*eig[m]/(1.0-rate[cat-1]*tt*(eig[m]/(1.0-invarfrac))/cvi)) * q;
    TEMP = eig[m];
    if (!gama && !invar)
      d2p += TEMP * TEMP * q;
    else
      d2p += (rate[cat-1]*rate[cat-1]*eig[m]*eig[m]*(1.0+1.0/cvi)/
              ((1.0-rate[cat-1]*tt*eig[m]/cvi)
               *(1.0-rate[cat-1]*tt*eig[m]/cvi))) * q;
  }
  if (nb1 == nb2) {
    p *= (1.0 - invarfrac);
    p += invarfrac;
  }
  dp *= (1.0 - invarfrac);
  d2p *= (1.0 - invarfrac);
}  /* predict */


void makedists(void)
{ /* compute the distances */
  long i, j, k, m, n, itterations, nb1, nb2, cat;
  double delta, lnlike, slope, curv;
  boolean neginfinity, inf, overlap;
  aas b1, b2;

  // RSGnote: Removed "custom" printing of number of species, since output_matrix_d() does so now.
  // if (!(printdata || (method == similarity)))
  //   fprintf(outfile, "%5ld\n", spp);

  if (progress)
  {
    sprintf(progbuf, "Computing distances:\n");
    print_progress(progbuf);
  }

  for (i = 0; i < spp; i++) {
    if (progress)
    {
      sprintf(progbuf, "  ");
      print_progress(progbuf);
      for (j = 0; j < nmlngth; j++)
      {
        sprintf(progbuf, "%c", nayme[i][j]);
        print_progress(progbuf);
      }
      sprintf(progbuf, "   ");
      print_progress(progbuf);
    }
    if (method == similarity)
      d[i][i] = 1.0;
    else
      d[i][i] = 0.0;
    for (j = 0; j <= i - 1; j++) {
      if (!(method & (kimura|similarity))) {
        if (method & (jtt|pmb|pam|mtrev|wag|mtmam))
          tt = 0.1/fracchange;
        else
          tt = 1.0; /* categories model */
        delta = tt / 2.0;
        itterations = 0;
        inf = false;
        do {
          lnlike = 0.0;
          slope = 0.0;
          curv = 0.0;
          neginfinity = false;
          overlap = false;
          for (k = 0; k < chars; k++) {
            if (oldweight[k] > 0) {
              cat = category[k];
              b1 = gnode[i][k];
              b2 = gnode[j][k];
              if (b1 != stop && b1 != del && b1 != quest && b1 != unk &&
                  b2 != stop && b2 != del && b2 != quest && b2 != unk) {
                overlap = true;
                p = 0.0;
                dp = 0.0;
                d2p = 0.0;
                nb1 = numaa[(long)b1 - (long)ala];
                nb2 = numaa[(long)b2 - (long)ala];
                if (b1 != asx && b1 != glx && b2 != asx && b2 != glx)
                  predict(nb1, nb2, cat);
                else {
                  if (b1 == asx) {
                    if (b2 == asx) {
                      predict(3L, 3L, cat);
                      predict(3L, 4L, cat);
                      predict(4L, 3L, cat);
                      predict(4L, 4L, cat);
                    } else {
                      if (b2 == glx) {
                        predict(3L, 6L, cat);
                        predict(3L, 7L, cat);
                        predict(4L, 6L, cat);
                        predict(4L, 7L, cat);
                      } else {
                        predict(3L, nb2, cat);
                        predict(4L, nb2, cat);
                      }
                    }
                  } else {
                    if (b1 == glx) {
                      if (b2 == asx) {
                        predict(6L, 3L, cat);
                        predict(6L, 4L, cat);
                        predict(7L, 3L, cat);
                        predict(7L, 4L, cat);
                      } else {
                        if (b2 == glx) {
                          predict(6L, 6L, cat);
                          predict(6L, 7L, cat);
                          predict(7L, 6L, cat);
                          predict(7L, 7L, cat);
                        } else {
                          predict(6L, nb2, cat);
                          predict(7L, nb2, cat);
                        }
                      }
                    } else {
                      if (b2 == asx) {
                        predict(nb1, 3L, cat);
                        predict(nb1, 4L, cat);
                        predict(nb1, 3L, cat);
                        predict(nb1, 4L, cat);
                      } else if (b2 == glx) {
                        predict(nb1, 6L, cat);
                        predict(nb1, 7L, cat);
                        predict(nb1, 6L, cat);
                        predict(nb1, 7L, cat);
                      }
                    }
                  }
                }
                if (p <= 0.0)
                  neginfinity = true;
                else {
                  lnlike += oldweight[k]*log(p);
                  slope += oldweight[k]*dp / p;
                  curv += oldweight[k]*(d2p / p - dp * dp / (p * p));
                }
              }
            }
          }
          itterations++;
          if (!overlap)
          {
            printf("\nWARNING: NO OVERLAP BETWEEN SEQUENCES %ld AND %ld; -1.0 WAS WRITTEN\n", i+1, j+1);
            tt = -1.0/fracchange;
            itterations = 20;
            inf = true;
          } else if (!neginfinity) {
            if (curv < 0.0) {
              tt -= slope / curv;
              if (tt > 10000.0) {
                printf("\nWARNING: INFINITE DISTANCE BETWEEN SPECIES %ld AND %ld; -1.0 WAS WRITTEN\n", i+1, j+1);
                tt = -1.0/fracchange;
                inf = true;
                itterations = 20;
              }
            }
            else {
              if ((slope > 0.0 && delta < 0.0) || (slope < 0.0 && delta > 0.0))
                delta /= -2;
              tt += delta;
            }
          } else {
            delta /= -2;
            tt += delta;
          }
          if (tt < epsilon && !inf)
            tt = epsilon;
        } while (itterations != 20);
      } else { /* kimura / similarity */
        m = 0;
        n = 0;
        for (k = 0; k < chars; k++) {
          b1 = gnode[i][k];
          b2 = gnode[j][k];
          if ((((long)b1 <= (long)val) || ((long)b1 == (long)ser))
              && (((long)b2 <= (long)val) || ((long)b2 == (long)ser))) {
            if (b1 == b2)
              m++;
            n++;
          }
        }
        p = 1 - (double)m / n;
        if (method == kimura) {
          dp = 1.0 - p - 0.2 * p * p;
          if (dp < 0.0) {
            printf("\nDISTANCE BETWEEN SEQUENCES %3ld AND %3ld IS TOO LARGE FOR KIMURA FORMULA\n",
                   i+1, j+1);
            tt = -1.0;
          } else
            tt = -log(dp);
        } else {              /* similarity */
          tt = 1.0 - p;
        }
      }
      d[i][j] = fracchange * tt;
      d[j][i] = d[i][j];
      if (progress) {
        sprintf(progbuf, ".");
        print_progress(progbuf);
      }
    }
    if (progress) {
      sprintf(progbuf, "\n");
      print_progress(progbuf);
    }
  }
  if (method != similarity)
  {
    // Write out distances.
    char **names;
    assert( d != NULL );
    names = stringnames_new();

    // RSGnote: Substitution of output_matrix_d() for old custom code.
    // (method != similarity) ==> MAT_MACHINE
    output_matrix_d(outfile, d, spp, spp, names, names, lower ? MAT_LOWERTRI : MAT_MACHINE);

    stringnames_delete(names);
  }
  else
  {
    // Write out distances.
    char **names;
    assert( d != NULL );
    names = stringnames_new();

    // RSGnote: Substitution of output_matrix_d() for old custom code.
    // (method == similarity) ==> MAT_HUMAN
    output_matrix_d(outfile, d, spp, spp, names, names, lower ? MAT_LOWERTRI : MAT_HUMAN);

    stringnames_delete(names);
  }

  if (progress)
  {
    sprintf(progbuf, "\nOutput written to file \"%s\".\n\n", outfilename);
    print_progress(progbuf);
  }
}  /* makedists */


void finalize_eigens(void)
{
  int i;

  if ( prob != NULL ) {
    if ( method == categories ) {
      /* We have created our own matrix, so free rows */
      for (i = 0; i < 20; i++)
        free(prob[i]);
    }
    /* Otherwise just pointers to static data */
    free(prob);
  }
  if ( method == categories ) {
    if ( eig != NULL )
      free(eig);
    if ( eigvecs != NULL )
      for (i = 0; i < 20; i++)
        free(eigvecs[i]);
    free(eigvecs);
  }
} /* finalize_eigens */


void protdistrun(void)
{
  // JRMdebug print
  /*
    printf("\nmethod: %i\n", method);
    printf("weights: %i\n", weights);
    printf("printdata: %i\n", printdata);
    printf("progress: %i\n", progress);
    printf("interleaved: %i\n", interleaved);
    printf("ttratio: %f\n", ttratio);
    printf("whichcode: %i\n", whichcode);
    printf("whichcat: %i\n", whichcat);
    printf("basesequal: %i\n", basesequal);
    printf("gama: %i\n", gama);
    printf("invar: %i\n", invar);
    printf("invarfrac: %f\n", invarfrac);
    printf("ease: %f\n", ease);
    printf("freqa: %f\n", freqa);
    printf("freqc: %f\n", freqc);
    printf("freqg: %f\n", freqg);
    printf("freqt: %f\n", freqt);
  */
  // do the actual work
  transition();
  fracchange = 1.0;             /** changed from 0.01   **/
  switch (method)
  {
    case jtt:
      code();
      useeigen(jttprobs, jtteigs);
      break;
    case pmb:
      code();
      useeigen(pmbprobs, pmbeigs);
      break;
    case pam:
      code();
      useeigen(pamprobs, pameigs);
      break;
    case mtrev:
      code();
      useeigen(mtrevprobs, mtreveigs);
      break;
    case wag:
      code();
      useeigen(wagprobs, wageigs);
      break;
    case mtmam:
      code();
      useeigen(mtmamprobs, mtmameigs);
      break;
    case kimura:                /* same as similarity */
    case similarity:
      break;
    case categories:
      code();
      protdist_cats();
      maketrans();              /* re-sets fracchange */
      qreigen(prob, 20L);
      break;
    default:                    /* Shouldn't happen */
      assert(0);
  }
  for (ith = 1; ith <= datasets; ith++) {
    doinput();
    if (ith == 1)
      firstset = false;
    if ((datasets > 1) && progress)
    {
      sprintf(progbuf, "\nData set # %ld:\n\n", ith);
      print_progress(progbuf);
    }
    makedists();
    fflush(outfile);
    fflush(outtree);
  }
  finalize_eigens();
  size_arrays(0, 0);
}


void protdist(
  char * infilename,
  char * wgtsfilename,
  char * catsfilename,
  char * OutfileName,
  char * outfileopt,
  char * Model,
  char * GammaDist,
  double FracInvar,
  double CoeffVar,
  int OneCat,
  int NumCats,

  // these are explicitly named because JNA doesn't pass arrays gracefully
  double SiteRate1,
  double SiteRate2,
  double SiteRate3,
  double SiteRate4,
  double SiteRate5,
  double SiteRate6,
  double SiteRate7,
  double SiteRate8,
  double SiteRate9,

  int SitesWeighted,
  char * GeneCode,
  char * AACat,
  double ProbCat,
  double TTratio,
  int useEqualBF,
  double BaseFreqA,
  double BaseFreqC,
  double BaseFreqG,
  double BaseFreqTU,
  int MultData,
  int MultDSet,
  int NumSets,
  int InputSeq,
  int PrintData,
  int DotDiff,
  int PrintInd)
{
  //printf("Hello from ProtDist!\n"); // JRMdebug

  int argc;
  Char *argv[1];
  argc = 1;
  argv[0] = "Protdist";
  phylipinit(argc, argv, NULL, true);

  /*
  //protdist_method method  = jtt;
  //bool    weights         = false;
  //bool    printdata       = false;
  //bool    progress        = true;
  //bool    interleaved     = true;
  //double  ttratio         = 2.0;
  //codetype whichcode      = universal;
  //cattype  whichcat       = george;
  //bool    basesequal      = true;
  //bool    gama            = false;
  //bool    invar           = false;
  //double  invarfrac       = 0.0;
  //double  ease            = 0.457;
  **double  fracchange      = 1.0;

  //double  freqa = 0.25, freqc = 0.25, freqg = 0.25, freqt = 0.25;

  //char * infile,
  //char * wgtfile,
  //char * catsfile,
  //char * outfile,
  //char * outfileopt,
  //char * Model,
  //char * GammaDist,
  //int OneSite,
  //int NumSites,

  // these are explicitly named because JNA doesn't pass arrays gracefully
  //double SiteRate1,
  //double SiteRate2,
  //double SiteRate3,
  //double SiteRate4,
  //double SiteRate5,
  //double SiteRate6,
  //double SiteRate7,
  //double SiteRate8,
  //double SiteRate9,

  //int SitesWeighted,
  //char * GeneCode,
  //char * AACat,
  //double ProbCat,
  //double TTratio,
  //int useEqualBF,
  //double BaseFreqA,
  //double BaseFreqC,
  //double BaseFreqG,
  //double BaseFreqTU,
  //int MultData,
  //int MultDSet,
  //int NumSets,
  //int InputSeq,
  //int PrintData,
  //int PrintInd);

  */

  if (SitesWeighted != 0)
  {
    weights = true;
  }
  else
  {
    weights = false;
  }

  if (useEqualBF != 0)
  {
    basesequal = true;
  }
  else
  {
    basesequal = false;
  }

  if (MultData != 0)
  {
    mulsets = true;
    datasets = NumSets;
  }
  else
  {
    mulsets = false;
    datasets = 1;
  }

  if (MultDSet != 0)
  {
    justwts = false;
  }
  else
  {
    justwts = true;
  }

  if (InputSeq !=0)
  {
    interleaved = true;
  }
  else
  {
    interleaved = false;
  }

  if (PrintData != 0)
  {
    printdata = true;
  }
  else
  {
    printdata = false;
  }

  if (DotDiff != 0)
  {
    dotdiff = true;
  }
  else
  {
    dotdiff = false;
  }

  if (PrintInd != 0)
  {
    progress = true;
  }
  else
  {
    progress = false;
  }

  if (!strcmp(Model, "JTT"))
  {
    method = jtt;
  }
  else if (!strcmp(Model, "HTPMB"))
  {
    method = pmb;
  }
  else if (!strcmp(Model, "DPAM"))
  {
    method = pam;
  }
  else if (!strcmp(Model, "mtRev"))
  {
    method = mtrev;
  }
  else if (!strcmp(Model, "WAG"))
  {
    method = wag;
  }
  else if (!strcmp(Model, "mtMam"))
  {
    method = mtmam;
  }
  else if (!strcmp(Model, "Kimura"))
  {
    method = kimura;
  }
  else if (!strcmp(Model, "Similarity"))
  {
    method = similarity;
  }
  else// if (!strcmp(Model, "Cat"))
  {
    method = categories;
  }

  if (!strcmp(GeneCode, "Universal"))
  {
    whichcode = universal;
  }
  else if (!strcmp(GeneCode, "Mitochondrial"))
  {
    whichcode = mito;
  }
  else if (!strcmp(GeneCode, "Vertebrate"))
  {
    whichcode = vertmito;
  }
  else if (!strcmp(GeneCode, "Fly"))
  {
    whichcode = flymito;
  }
  else //if (!strcmp(GeneCode, "Yeast"))
  {
    whichcode = yeastmito;
  }

  if (!strcmp(AACat, "GHB"))
  {
    whichcat = george;
  }
  else if (!strcmp(AACat, "Chemical"))
  {
    whichcat = chemical;
  }
  else //if (!strcmp(AACat, "Hall"))
  {
    whichcat = hall;
  }

  if (!strcmp(GammaDist, "No"))
  {
    gama  = false;
    invar = false;
  }
  else if (!strcmp(GammaDist, "Gamma"))
  {
    gama  = true;
    invar = false;
  }
  else //if (!strcmp(GammaDist, "Invariant"))
  {
    gama  = false;
    invar = true;
  }

  if (OneCat != 0)
  {
    ctgry = false;
    categs = 1;
  }
  else
  {
    ctgry = true;
    categs = NumCats;
  }

  invarfrac = FracInvar;
  cvi = 1.0 / (CoeffVar * CoeffVar);

  rate[0] = SiteRate1;
  rate[1] = SiteRate2;
  rate[2] = SiteRate3;
  rate[3] = SiteRate4;
  rate[4] = SiteRate5;
  rate[5] = SiteRate6;
  rate[6] = SiteRate7;
  rate[7] = SiteRate8;
  rate[8] = SiteRate9;

  ttratio = TTratio;

  freqa = BaseFreqA;
  freqc = BaseFreqC;
  freqg = BaseFreqG;
  freqt = BaseFreqTU;

  ease = ProbCat;

  // everything translated, start the run
  infile = fopen(infilename, "r");
  outfile = fopen(OutfileName, outfileopt);
  strcpy(outfilename, OutfileName);

  if (progress)
  {
    progfile = fopen("progress.txt", "w");
    fclose(progfile); // make sure it is there for the Java code to detect
    progfile = fopen("progress.txt", "w");
  }

  if (ctgry)
  {
    //printf("catsfilename: %s\n", catsfilename); // JRMdebug
    catfile = fopen(catsfilename, "r");
  }

  if (weights || justwts)
  {
    weightfile = fopen(wgtsfilename, "r");
  }

  ibmpc = IBMCRT;
  ansi = ANSICRT;
  firstset = true;
  protdist_inputnumbers();
  protdistrun();

  FClose(infile);
  FClose(outfile);

  if (ctgry)
  {
    FClose(catfile);
  }

  if (weights || justwts)
  {
    FClose(weightfile);
  }
  //printf("\ndone\n"); // JRMdebug
}


int main(int argc, Char *argv[])
{  /* ML Protein distances by PMB, JTT, PAM or categories model */
#ifdef MAC
  argc = 1;   /* macsetup("Protdist", ""); */
  argv[0] = "Protdist";
#endif
  phylipinit(argc, argv, NULL, false);
  openfile(&infile, INFILE, "input file", "r", argv[0], infilename);
  openfile(&outfile, OUTFILE, "output file", "w", argv[0], outfilename);
  if (ctgry)
    openfile(&catfile, CATFILE, "categories file", "r", argv[0], catfilename);
  if (weights || justwts)
    openfile(&weightfile, WEIGHTFILE, "weights file", "r", argv[0], weightfilename);

  ibmpc = IBMCRT;
  ansi = ANSICRT;
  mulsets = false;
  datasets = 1;
  dotdiff = true;
  firstset = true;
  getoptions();
  protdist_inputnumbers();
  protdistrun();
  FClose(outfile);
  FClose(infile);
#ifdef MAC
  fixmacfile(outfilename);
#endif
  return 0;
}  /* Protein distances */


// End.
